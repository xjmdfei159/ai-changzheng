<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <div id="map-id" style="display: none;">map</div>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_1847de95be0bd1ebe87a3dd0366aead5 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

            <!-- æ·»åŠ è‡ªå®šä¹‰CSSå’ŒJavaScriptæ¥å®ç°ç•Œé¢å¢å¼º -->
            <style>
                /* å·¦ä¾§æ‚¬æµ®çª—æ ·å¼ */
                #progress-panel {
                    position: fixed;
                    left: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 150px;
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #progress-panel h3 {
                    margin-top: 0;
                    margin-bottom: 10px;
                    font-size: 16px;
                    color: #d32f2f;
                    text-align: center;
                }
                
                #progress-info {
                    margin-bottom: 15px;
                    text-align: center;
                }
                
                #progress-bar {
                    width: 100%;
                    height: 8px;
                    background: #e0e0e0;
                    border-radius: 4px;
                    margin: 10px 0;
                    overflow: hidden;
                }
                
                #progress-fill {
                    height: 100%;
                    background: #d32f2f;
                    width: 0%;
                    transition: width 0.3s ease;
                }
                
                .control-btn {
                    width: 100%;
                    padding: 8px;
                    margin: 5px 0;
                    background: #d32f2f;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                }
                
                .control-btn:hover {
                    background: #b71c1c;
                }
                
                /* é¡¶éƒ¨æ ‡å¿—æ ·å¼ */
                #header-banner {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 60px;
                    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    z-index: 1001;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #header-banner h1 {
                    margin: 0;
                    font-size: 24px;
                    font-weight: bold;
                }
                
                /* å³ä¾§è¯¦æƒ…é¡µæ ·å¼ */
                #details-panel {
                    position: fixed;
                    right: -400px;
                    top: 60px;
                    bottom: 0;
                    width: 400px;
                    background: rgba(255, 255, 255, 0.95);
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    transition: right 0.3s ease;
                    padding: 20px;
                    overflow-y: auto;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #details-panel.show {
                    right: 0;
                }
                
                #details-panel h2 {
                    margin-top: 0;
                    color: #d32f2f;
                    font-size: 20px;
                }
                
                #details-panel h3 {
                    color: #757575;
                    font-size: 16px;
                    margin-top: 5px;
                }
                
                .detail-section {
                    margin-bottom: 20px;
                }
                
                .detail-section h4 {
                    color: #333;
                    font-size: 14px;
                    margin-bottom: 8px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #e0e0e0;
                }
                
                .detail-section p {
                    line-height: 1.6;
                    color: #555;
                    margin: 0;
                }
                
                .close-btn {
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    width: 30px;
                    height: 30px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                    color: #333;
                    font-size: 20px;
                    line-height: 1;
                    padding: 0;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                }
                
                .close-btn:hover {
                    opacity: 0.8;
                }
                
                /* ç¡®ä¿åœ°å›¾å®¹å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—´æ˜¾ç¤ºæ‰€æœ‰å†…å®¹ */
                .map-container {
                    position: relative;
                    width: 100%;
                    height: 100vh;
                }
                
                /* éŸ³æ•ˆæ§åˆ¶æ ·å¼ */
                #audio-control {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid #e0e0e0;
                }
                
                #audio-btn {
                    width: 100%;
                    padding: 8px;
                    background: #2196f3;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                }
                
                #audio-btn:hover {
                    background: #1976d2;
                }
                
                /* åœ°å›¾å›¾ä¾‹æ ·å¼ */
                .legend {
                    background: white;
                    padding: 10px;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    font-size: 12px;
                    line-height: 1.5;
                }
                
                .legend i {
                    width: 15px;
                    height: 15px;
                    float: left;
                    margin-right: 8px;
                    opacity: 0.8;
                }
            </style>
        </head>
<body>
    <!-- é¡¶éƒ¨æ ‡å¿— -->
    <div id="header-banner">
        <h1>çº¢å†›é•¿å¾è·¯çº¿å›¾</h1>
    </div>
    
    <!-- å·¦ä¾§æ‚¬æµ®çª— -->
    <div id="progress-panel">
        <h3>é•¿å¾è¿›åº¦</h3>
        <div id="progress-info">
            <div>å·²å®Œæˆ: <span id="progress-text">0%</span></div>
            <div id="progress-bar">
                <div id="progress-fill"></div>
            </div>
        </div>
        <button class="control-btn" onclick="prevNode()">ä¸Šä¸€ç«™</button>
        <button class="control-btn" onclick="nextNode()">ä¸‹ä¸€ç«™</button>
        <button class="control-btn" onclick="resetMap()">é‡ç½®åœ°å›¾</button>
        
        <!-- éŸ³æ•ˆæ§åˆ¶ -->
        <div id="audio-control">
            <button id="audio-btn" onclick="toggleAudio()">æ’­æ”¾èƒŒæ™¯éŸ³ä¹</button>
        </div>
    </div>
    
    <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
    <div id="details-panel">
        <h2 id="detail-title">ç«™ç‚¹è¯¦æƒ…</h2>
        <h3 id="detail-description"></h3>
        
        <div class="detail-section">
            <h4>åœ°ç‚¹ä»‹ç»</h4>
            <p id="detail-introduction"></p>
        </div>
        
        <div class="detail-section">
            <h4>ä¸»è¦äº‹ä»¶</h4>
            <p id="detail-events"></p>
        </div>
        
        <div class="detail-section">
            <h4>å†å²æ•…äº‹</h4>
            <p id="detail-story"></p>
        </div>
        
        <div class="detail-section">
            <img id="detail-image" src="" alt="å†å²å›¾ç‰‡" style="width: 100%; border-radius: 4px; margin-top: 10px;">
        </div>
    </div>
    
    <!-- å…³é—­æŒ‰é’® -->
    <button class="close-btn" onclick="closeDetails()">Ã—</button>
    
    <!-- åœ°å›¾å®¹å™¨ -->
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <script>
        // åˆ›å»ºåœ°å›¾å®ä¾‹
        var map = L.map('map').setView([25.8856, 116.0270], 8);
        
        // æ·»åŠ åŸºç¡€å›¾å±‚
        var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // é•¿å¾è·¯çº¿èŠ‚ç‚¹æ•°æ®
        var longMarchWaypoints = [
            {
                name: 'ç‘é‡‘',
                location: [25.8856, 116.0270],
                description: 'é•¿å¾å‡ºå‘åœ°',
                introduction: 'ç‘é‡‘æ˜¯ä¸­åè‹ç»´åŸƒå…±å’Œå›½ä¸´æ—¶ä¸­å¤®æ”¿åºœæ‰€åœ¨åœ°ï¼Œè¢«èª‰ä¸ºçº¢è‰²æ•…éƒ½ã€å…±å’Œå›½æ‘‡ç¯®ã€‚',
                events: '1934å¹´10æœˆ10æ—¥ï¼Œä¸­å…±ä¸­å¤®ã€ä¸­é©å†›å§”ç‡ä¸­å¤®çº¢å†›ä¸»åŠ›ä»ç‘é‡‘ç­‰åœ°å‡ºå‘ï¼Œå¼€å§‹é•¿å¾ã€‚',
                story: '1934å¹´10æœˆï¼Œç”±äºç¬¬äº”æ¬¡å"å›´å‰¿"å¤±è´¥ï¼Œä¸­å¤®çº¢å†›è¢«è¿«å®è¡Œæˆ˜ç•¥æ€§è½¬ç§»ã€‚åœ¨ç‘é‡‘ï¼Œçº¢å†›è¿›è¡Œäº†å……åˆ†çš„å‡†å¤‡ï¼ŒåŒ…æ‹¬äººå‘˜ã€ç‰©èµ„çš„é›†ç»“å’Œæ”¿æ²»åŠ¨å‘˜ã€‚çº¢å†›å°†å£«ä»¬æ€€ç€å¯¹é©å‘½äº‹ä¸šçš„åšå®šä¿¡å¿µï¼Œè¸ä¸Šäº†è‰°è‹¦å“ç»çš„é•¿å¾ä¹‹è·¯ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/e3b61520c2e4f516b1c4651f4691815d.jpeg'
            },
            {
                name: 'é›©éƒ½',
                location: [25.9811, 115.4442],
                description: 'äºéƒ½æ²³æ¸¡æ²³',
                introduction: 'é›©éƒ½ï¼ˆä»Šäºéƒ½ï¼‰æ˜¯ä¸­å¤®çº¢å†›é•¿å¾çš„ç¬¬ä¸€æ¸¡ï¼Œæ˜¯çº¢å†›ç¦»å¼€ä¸­å¤®è‹åŒºçš„æœ€åä¸€ç«™ã€‚',
                events: '1934å¹´10æœˆ16æ—¥è‡³19æ—¥ï¼Œä¸­å¤®çº¢å†›ä¸»åŠ›8.6ä¸‡ä½™äººä»äºéƒ½æ²³çš„8ä¸ªæ¸¡å£æ¸¡æ²³ï¼Œå¼€å§‹äº†è‘—åçš„äºŒä¸‡äº”åƒé‡Œé•¿å¾ã€‚',
                story: 'åœ¨äºéƒ½ï¼Œå½“åœ°ç¾¤ä¼—ç§¯ææ”¯æŒçº¢å†›ï¼Œä»–ä»¬ä¸ä»…æä¾›äº†å¤§é‡çš„èˆ¹åªï¼Œè¿˜å¸®åŠ©çº¢å†›æ­å»ºæµ®æ¡¥ã€‚è®¸å¤šç¾¤ä¼—è‡ªå‘ä¸ºçº¢å†›æˆ˜å£«é€èŒ¶é€æ°´ï¼Œç”šè‡³æŠŠè‡ªå·±çš„å£ç²®æ‹¿å‡ºæ¥æ”¯æ´çº¢å†›ã€‚åœ¨ç¾¤ä¼—çš„å¸®åŠ©ä¸‹ï¼Œçº¢å†›æˆåŠŸæ¸¡è¿‡äº†äºéƒ½æ²³ï¼Œå¼€å§‹äº†è‰°è‹¦çš„é•¿å¾å†ç¨‹ã€‚',
                image: 'https://img.zcool.cn/community/01b4d45d383265a8012193a3696d2e.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: 'éµä¹‰',
                location: [27.7172, 106.9271],
                description: 'éµä¹‰ä¼šè®®å¬å¼€åœ°',
                introduction: 'éµä¹‰æ˜¯ä¸­å›½é©å‘½å†å²ä¸Šçš„é‡è¦è½¬æŠ˜ç‚¹ï¼Œéµä¹‰ä¼šè®®ç¡®ç«‹äº†æ¯›æ³½ä¸œåœ¨å…šä¸­å¤®å’Œçº¢å†›çš„é¢†å¯¼åœ°ä½ã€‚',
                events: '1935å¹´1æœˆ15æ—¥è‡³17æ—¥ï¼Œä¸­å…±ä¸­å¤®åœ¨éµä¹‰å¬å¼€æ”¿æ²»å±€æ‰©å¤§ä¼šè®®ï¼Œç¡®ç«‹äº†æ¯›æ³½ä¸œåœ¨å…šä¸­å¤®å’Œçº¢å†›çš„é¢†å¯¼åœ°ä½ã€‚',
                story: 'éµä¹‰ä¼šè®®æ˜¯ä¸­å›½å…±äº§å…šå†å²ä¸Šä¸€ä¸ªç”Ÿæ­»æ”¸å…³çš„è½¬æŠ˜ç‚¹ã€‚ä¼šè®®é›†ä¸­è§£å†³äº†å½“æ—¶å…·æœ‰å†³å®šæ„ä¹‰çš„å†›äº‹å’Œç»„ç»‡é—®é¢˜ï¼Œç»“æŸäº†ç‹æ˜"å·¦"å€¾æ•™æ¡ä¸»ä¹‰åœ¨å…šä¸­å¤®çš„ç»Ÿæ²»ï¼Œç¡®ç«‹äº†æ¯›æ³½ä¸œåœ¨å…šä¸­å¤®å’Œçº¢å†›çš„é¢†å¯¼åœ°ä½ã€‚è¿™æ¬¡ä¼šè®®æŒ½æ•‘äº†å…šã€æŒ½æ•‘äº†çº¢å†›ã€æŒ½æ•‘äº†ä¸­å›½é©å‘½ï¼Œæ˜¯å…šçš„å†å²ä¸Šä¸€ä¸ªä¼Ÿå¤§çš„è½¬æŠ˜ç‚¹ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/b3bd8b8d9bceb918e1421e11b91a8d83.jpeg'
            },
            {
                name: 'èµ¤æ°´',
                location: [28.5081, 105.7975],
                description: 'å››æ¸¡èµ¤æ°´',
                introduction: 'èµ¤æ°´æ˜¯çº¢å†›é•¿å¾ä¸­è‘—åçš„å››æ¸¡èµ¤æ°´æˆ˜å½¹å‘ç”Ÿåœ°ï¼Œæ˜¯æ¯›æ³½ä¸œå†›äº‹æŒ‡æŒ¥è‰ºæœ¯çš„å¾—æ„ä¹‹ç¬”ã€‚',
                events: '1935å¹´1æœˆ19æ—¥è‡³3æœˆ22æ—¥ï¼Œä¸­å¤®çº¢å†›åœ¨æ¯›æ³½ä¸œç­‰æŒ‡æŒ¥ä¸‹ï¼Œå››æ¸¡èµ¤æ°´ï¼Œå·§å¦™åœ°è·³å‡ºäº†å›½æ°‘å…šå†›çš„åŒ…å›´åœˆã€‚',
                story: 'å››æ¸¡èµ¤æ°´æˆ˜å½¹æ˜¯çº¢å†›é•¿å¾ä¸­æœ€ç²¾å½©çš„å†›äº‹è¡ŒåŠ¨ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯æ¯›æ³½ä¸œå†›äº‹æŒ‡æŒ¥è‰ºæœ¯çš„å¾—æ„ä¹‹ç¬”ã€‚åœ¨æ¯›æ³½ä¸œçš„æŒ‡æŒ¥ä¸‹ï¼Œçº¢å†›é‡‡å–çµæ´»æœºåŠ¨çš„æˆ˜ç•¥æˆ˜æœ¯ï¼Œå£°ä¸œå‡»è¥¿ï¼Œè¿·æƒ‘æ•Œäººï¼ŒæˆåŠŸåœ°æ‘†è„±äº†å›½æ°‘å…šå†›çš„å›´è¿½å µæˆªï¼Œå®ç°äº†æˆ˜ç•¥è½¬ç§»çš„ç›®æ ‡ã€‚',
                image: 'https://img.zcool.cn/community/01f02858a471e7a801219c77d2e322.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: 'é‡‘æ²™æ±Ÿ',
                location: [27.1564, 100.2562],
                description: 'å·§æ¸¡é‡‘æ²™æ±Ÿ',
                introduction: 'é‡‘æ²™æ±Ÿæ˜¯é•¿æ±Ÿçš„ä¸Šæ¸¸ï¼Œæ°´æµæ¹æ€¥ï¼Œæ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€é“å¤©é™©ã€‚',
                events: '1935å¹´5æœˆ3æ—¥è‡³9æ—¥ï¼Œä¸­å¤®çº¢å†›å¹²éƒ¨å›¢åœ¨åæœ‰è¿½å…µçš„æƒ…å†µä¸‹ï¼Œä»…å‡­7åªå°èˆ¹ï¼Œç”¨6å¤©6å¤œæ—¶é—´å·§æ¸¡é‡‘æ²™æ±Ÿã€‚',
                story: 'é‡‘æ²™æ±Ÿæˆ˜å½¹æ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€æ¬¡é‡è¦æˆ˜å½¹ã€‚çº¢å†›å…ˆå¤´éƒ¨é˜ŸåŒ–è£…æˆå›½æ°‘å…šå†›ï¼Œæ™ºå–äº†çšå¹³æ¸¡ï¼Œå¹¶æ§åˆ¶äº†æ¸¡å£ã€‚å½“åœ°ç¾¤ä¼—å¸®åŠ©çº¢å†›ä»…ç”¨7åªå°èˆ¹ï¼Œåœ¨6å¤©6å¤œæ—¶é—´é‡Œï¼Œå°†ä¸­å¤®çº¢å†›ä¸»åŠ›å…¨éƒ¨æ¸¡è¿‡äº†é‡‘æ²™æ±Ÿï¼ŒæˆåŠŸåœ°æ‘†è„±äº†å›½æ°‘å…šå†›çš„å›´è¿½å µæˆªã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/a6a3b39b0bbd5f2f1ce3d1b1f8e28d8e.jpeg'
            },
            {
                name: 'å¤§æ¸¡æ²³',
                location: [29.4333, 102.2167],
                description: 'å¼ºæ¸¡å¤§æ¸¡æ²³',
                introduction: 'å¤§æ¸¡æ²³æ˜¯çº¢å†›é•¿å¾ä¸­çš„åˆä¸€é“å¤©é™©ï¼Œæ°´æµæ¹æ€¥ï¼Œä¸¤å²¸æ‚¬å´–å³­å£ã€‚',
                events: '1935å¹´5æœˆ24æ—¥è‡³25æ—¥ï¼Œä¸­å¤®çº¢å†›åœ¨å®‰é¡ºåœºå¼ºæ¸¡å¤§æ¸¡æ²³ï¼Œåå…«å‹‡å£«å†’ç€æ•Œäººçš„æªæ—å¼¹é›¨ï¼ŒæˆåŠŸçªç ´å¤©é™©ã€‚',
                story: 'å¼ºæ¸¡å¤§æ¸¡æ²³æ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€æ¬¡å‹‡æ•¢å£®ä¸¾ã€‚åœ¨æ•Œäººçš„ä¸¥å¯†é˜²å®ˆä¸‹ï¼Œçº¢å†›åå…«å‹‡å£«åœ¨ç«åŠ›æ©æŠ¤ä¸‹ï¼Œä¹˜åæœ¨èˆ¹å¼ºè¡Œæ¸¡æ²³ï¼ŒæˆåŠŸåœ°çªç ´äº†æ•Œäººçš„é˜²çº¿ã€‚è¿™æ¬¡æˆ˜å½¹å±•ç°äº†çº¢å†›æˆ˜å£«ä¸æ€•ç‰ºç‰²ã€è‹±å‹‡æ— ç•çš„é©å‘½ç²¾ç¥ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/a40e6c959663850777e278d9cf295be2.jpeg'
            },
            {
                name: 'æ³¸å®šæ¡¥',
                location: [29.9428, 102.2956],
                description: 'é£å¤ºæ³¸å®šæ¡¥',
                introduction: 'æ³¸å®šæ¡¥æ˜¯ä¸€åº§é“ç´¢æ¡¥ï¼Œæ¨ªè·¨å¤§æ¸¡æ²³ï¼Œæ˜¯çº¢å†›é•¿å¾ä¸­çš„å…³é”®èŠ‚ç‚¹ã€‚',
                events: '1935å¹´5æœˆ29æ—¥ï¼Œ22åçº¢å†›æˆ˜å£«åœ¨ç«åŠ›æ©æŠ¤ä¸‹ï¼Œæ”€ç€é“ç´¢å‘å¯¹å²¸å†²é”‹ï¼Œæœ€ç»ˆå¤ºä¸‹æ³¸å®šæ¡¥ã€‚',
                story: 'é£å¤ºæ³¸å®šæ¡¥æ˜¯çº¢å†›é•¿å¾ä¸­æœ€æƒŠé™©ã€æœ€æ‚²å£®çš„æˆ˜å½¹ä¹‹ä¸€ã€‚åœ¨æ•Œäººæ‹†é™¤äº†æ¡¥ä¸Šçš„æœ¨æ¿ï¼Œåªå‰©ä¸‹13æ ¹é“ç´¢çš„æƒ…å†µä¸‹ï¼Œ22åçº¢å†›æˆ˜å£«æ‰‹æŒå†²é”‹æªï¼Œèº«èƒŒé©¬åˆ€ï¼Œè…°ç¼ æ‰‹æ¦´å¼¹ï¼Œå†’ç€æ•Œäººçš„æªæ—å¼¹é›¨ï¼Œæ”€ç€é“ç´¢å‘å¯¹å²¸å†²é”‹ã€‚æœ€ç»ˆï¼Œçº¢å†›æˆåŠŸåœ°å¤ºä¸‹äº†æ³¸å®šæ¡¥ï¼Œä¸ºä¸­å¤®çº¢å†›åŒ—ä¸Šæ‰“å¼€äº†é€šé“ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/35e4fbd5b33c4307160c507a8133afb1.jpeg'
            },
            {
                name: 'å¤¹é‡‘å±±',
                location: [30.6853, 102.8677],
                description: 'ç¿»è¶Šå¤¹é‡‘å±±',
                introduction: 'å¤¹é‡‘å±±æ˜¯çº¢å†›é•¿å¾ä¸­ç¿»è¶Šçš„ç¬¬ä¸€åº§å¤§é›ªå±±ï¼Œæµ·æ‹”4000å¤šç±³ï¼Œå±±ä¸Šç»ˆå¹´ç§¯é›ªï¼Œç©ºæ°”ç¨€è–„ã€‚',
                events: '1935å¹´6æœˆ12æ—¥ï¼Œä¸­å¤®çº¢å†›å…ˆå¤´éƒ¨é˜Ÿç¿»è¶Šé•¿å¾é€”ä¸­ç¬¬ä¸€åº§å¤§é›ªå±±â€”â€”å¤¹é‡‘å±±ï¼Œå±±ä¸Šç»ˆå¹´ç§¯é›ªï¼Œç©ºæ°”ç¨€è–„ã€‚',
                story: 'ç¿»è¶Šå¤¹é‡‘å±±æ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€æ¬¡è‰°è‹¦å“ç»çš„è€ƒéªŒã€‚å±±ä¸Šç»ˆå¹´ç§¯é›ªï¼Œç©ºæ°”ç¨€è–„ï¼Œæ°”æ¸©æä½ï¼Œè®¸å¤šçº¢å†›æˆ˜å£«å› ä¸ºä¸¥å¯’ã€ç¼ºæ°§è€Œç‰ºç‰²ã€‚ä½†çº¢å†›æˆ˜å£«ä»¬å‘æ‰¬äº†ä¸æ€•è‹¦ã€ä¸æ€•æ­»çš„é©å‘½ç²¾ç¥ï¼Œäº’ç›¸å¸®åŠ©ï¼Œäº’ç›¸é¼“åŠ±ï¼Œæœ€ç»ˆæˆåŠŸåœ°ç¿»è¶Šäº†å¤¹é‡‘å±±ã€‚',
                image: 'https://img.zcool.cn/community/01611d58a471e9a801219c77557881.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: 'æ‡‹åŠŸ',
                location: [31.5543, 102.4531],
                description: 'ä¸çº¢å››æ–¹é¢å†›ä¼šå¸ˆ',
                introduction: 'æ‡‹åŠŸæ˜¯ä¸­å¤®çº¢å†›ä¸çº¢å››æ–¹é¢å†›ä¼šå¸ˆçš„åœ°ç‚¹ï¼Œæ ‡å¿—ç€çº¢å†›åŠ›é‡çš„å£®å¤§ã€‚',
                events: '1935å¹´6æœˆ18æ—¥ï¼Œä¸­å¤®çº¢å†›ä¸çº¢å››æ–¹é¢å†›åœ¨æ‡‹åŠŸä¼šå¸ˆï¼Œä¸¤å†›å°†å£«æ¬¢æ¬£é¼“èˆï¼Œåº†ç¥èƒœåˆ©ä¼šå¸ˆã€‚',
                story: 'æ‡‹åŠŸä¼šå¸ˆæ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€ä¸ªé‡è¦é‡Œç¨‹ç¢‘ã€‚ä¸­å¤®çº¢å†›ä¸çº¢å››æ–¹é¢å†›çš„èƒœåˆ©ä¼šå¸ˆï¼Œå£®å¤§äº†çº¢å†›çš„åŠ›é‡ï¼Œå¢å¼ºäº†çº¢å†›çš„ä¿¡å¿ƒã€‚ä¸¤å†›å°†å£«äº’ç›¸å­¦ä¹ ï¼Œäº’ç›¸å¸®åŠ©ï¼Œç»“ä¸‹äº†æ·±æ·±çš„é©å‘½å‹è°Šã€‚',
                image: 'https://img.zcool.cn/community/015c5558a471e8a801219c779f01fc.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: 'æ¾æ½˜è‰åœ°',
                location: [32.6000, 103.8000],
                description: 'è¿‡è‰åœ°',
                introduction: 'æ¾æ½˜è‰åœ°æ˜¯çº¢å†›é•¿å¾ä¸­æœ€è‰°è‹¦çš„è·¯æ®µä¹‹ä¸€ï¼Œåˆ°å¤„æ˜¯æ²¼æ³½æ³¥æ½­ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šé™·è¿›å»ã€‚',
                events: '1935å¹´8æœˆ21æ—¥è‡³26æ—¥ï¼Œä¸­å¤®çº¢å†›è¿‡æ¾æ½˜è‰åœ°ï¼Œè‰åœ°èŒ«èŒ«æ— è¾¹ï¼Œåˆ°å¤„æ˜¯æ²¼æ³½æ³¥æ½­ï¼Œä¸å°‘çº¢å†›æˆ˜å£«é™·å…¥æ³¥æ½­ç‰ºç‰²ã€‚',
                story: 'è¿‡è‰åœ°æ˜¯çº¢å†›é•¿å¾ä¸­æœ€è‰°è‹¦çš„å†ç¨‹ä¹‹ä¸€ã€‚è‰åœ°èŒ«èŒ«æ— è¾¹ï¼Œåˆ°å¤„æ˜¯æ²¼æ³½æ³¥æ½­ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šé™·è¿›å»ï¼Œè€Œä¸”æ²¡æœ‰é£Ÿç‰©ï¼Œæ²¡æœ‰æ°´ï¼Œè®¸å¤šçº¢å†›æˆ˜å£«å› ä¸ºé¥¥é¥¿ã€å¯’å†·ã€ç–¾ç—…è€Œç‰ºç‰²ã€‚ä½†çº¢å†›æˆ˜å£«ä»¬å‘æ‰¬äº†é©å‘½ä¹è§‚ä¸»ä¹‰ç²¾ç¥ï¼Œäº’ç›¸å¸®åŠ©ï¼Œäº’ç›¸é¼“åŠ±ï¼Œæœ€ç»ˆæˆåŠŸåœ°èµ°å‡ºäº†è‰åœ°ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/ce287241f06b1665e6b1fc778a7fb59d.jpeg'
            },
            {
                name: 'å´èµ·é•‡',
                location: [36.92785, 108.17611],
                description: 'é•¿å¾ç»ˆç‚¹',
                introduction: 'å´èµ·é•‡æ˜¯ä¸­å¤®çº¢å†›é•¿å¾çš„ç»ˆç‚¹ï¼Œæ ‡å¿—ç€é•¿å¾çš„èƒœåˆ©ç»“æŸã€‚',
                events: '1935å¹´10æœˆ19æ—¥ï¼Œä¸­å¤®çº¢å†›åˆ°è¾¾é™•åŒ—å´èµ·é•‡ï¼Œä¸é™•åŒ—çº¢å†›ä¼šå¸ˆï¼Œèƒœåˆ©å®Œæˆäº†äºŒä¸‡äº”åƒé‡Œé•¿å¾ã€‚',
                story: 'å´èµ·é•‡ä¼šå¸ˆæ˜¯çº¢å†›é•¿å¾èƒœåˆ©çš„æ ‡å¿—ã€‚ç»è¿‡ä¸€å¹´å¤šçš„è‰°è‹¦è·‹æ¶‰ï¼Œä¸­å¤®çº¢å†›ç»ˆäºåˆ°è¾¾äº†é™•åŒ—ï¼Œä¸é™•åŒ—çº¢å†›èƒœåˆ©ä¼šå¸ˆã€‚é•¿å¾çš„èƒœåˆ©ï¼Œä¿å­˜äº†å…šå’Œçº¢å†›çš„åŸºå¹²åŠ›é‡ï¼Œæ‰“å¼€äº†ä¸­å›½é©å‘½çš„æ–°å±€é¢ã€‚',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/18afdc74229304940c6cf7756957d376.jpeg'
            }
        ];
        
        // å¢å¼ºç‰ˆé•¿å¾è·¯çº¿åæ ‡
        var enhancedMarchCoordinates = [
            // ç‘é‡‘åˆ°é›©éƒ½æ®µ
            [25.8856, 116.0270],  // ç‘é‡‘
            [25.9250, 115.8700],  // äºéƒ½æ²³æ¸¡å£é™„è¿‘
            [25.9811, 115.4442],  // é›©éƒ½
            
            // é›©éƒ½åˆ°éµä¹‰æ®µ
            [25.9000, 114.9000],  // å‘æ¹˜æ±Ÿæ–¹å‘
            [25.6000, 113.9000],  // æ¹˜æ±Ÿæˆ˜å½¹é™„è¿‘
            [26.0000, 113.0000],  // è´µå·è¾¹ç•Œ
            [26.5000, 111.8000],  // è´µå·å¢ƒå†…
            [27.1000, 109.8000],  // æ¥è¿‘éµä¹‰
            [27.7172, 106.9271],  // éµä¹‰
            
            // éµä¹‰åˆ°èµ¤æ°´æ®µ
            [27.8000, 106.5000],  // éµä¹‰é™„è¿‘
            [28.0000, 106.2000],  // å››æ¸¡èµ¤æ°´è·¯çº¿ç‚¹1
            [28.2000, 105.9000],  // å››æ¸¡èµ¤æ°´è·¯çº¿ç‚¹2
            [28.4000, 105.8000],  // å››æ¸¡èµ¤æ°´è·¯çº¿ç‚¹3
            [28.5081, 105.7975],  // èµ¤æ°´
            
            // èµ¤æ°´åˆ°é‡‘æ²™æ±Ÿæ®µ
            [28.3000, 105.2000],  // å‘é‡‘æ²™æ±Ÿæ–¹å‘
            [27.9000, 104.5000],  // äº‘å—å¢ƒå†…
            [27.5000, 103.2000],  // æ¥è¿‘é‡‘æ²™æ±Ÿ
            [27.1564, 100.2562],  // é‡‘æ²™æ±Ÿ
            
            // é‡‘æ²™æ±Ÿåˆ°å¤§æ¸¡æ²³æ®µ
            [27.5000, 100.0000],  // ç»§ç»­åŒ—ä¸Š
            [28.0000, 101.0000],  // å››å·å¢ƒå†…
            [28.8000, 101.8000],  // æ¥è¿‘å¤§æ¸¡æ²³
            [29.4333, 102.2167],  // å¤§æ¸¡æ²³
            
            // å¤§æ¸¡æ²³åˆ°æ³¸å®šæ¡¥æ®µ
            [29.6000, 102.2500],  // å‘æ³¸å®šæ¡¥æ–¹å‘
            [29.9428, 102.2956],  // æ³¸å®šæ¡¥
            
            // æ³¸å®šæ¡¥åˆ°æ‡‹åŠŸæ®µï¼ˆç®€åŒ–ï¼Œä¸å†æ˜¾ç¤ºå…·ä½“é›ªå±±ä½ç½®ï¼‰
            [30.1000, 102.4000],  // å‘è¥¿åŒ—æ–¹å‘
            [30.5000, 102.6000],  // ç»§ç»­åŒ—ä¸Š
            [31.0000, 102.5000],  // ç»§ç»­åŒ—ä¸Š
            [31.3000, 102.4500],  // æ¥è¿‘æ‡‹åŠŸ
            [31.5543, 102.4531],  // æ‡‹åŠŸï¼ˆä¸çº¢å››æ–¹é¢å†›ä¼šå¸ˆï¼‰
            
            // æ‡‹åŠŸåˆ°å´èµ·é•‡æ®µï¼ˆç®€åŒ–æ¾æ½˜è‰åœ°è·¯çº¿ï¼‰
            [31.8000, 102.8000],  // å‘æ¾æ½˜è‰åœ°æ–¹å‘
            [32.0000, 103.0000],  // æ¾æ½˜è‰åœ°é™„è¿‘
            [32.3000, 103.4000],  // æ¾æ½˜è‰åœ°åŒ—éƒ¨
            [32.6047, 103.6553],  // æ¾æ½˜è‰åœ°ï¼ˆæ›´ç²¾ç¡®çš„åæ ‡ï¼‰
            [33.0000, 104.0000],  // ç¦»å¼€è‰åœ°
            [33.5000, 104.5000],  // ç”˜è‚ƒå¢ƒå†…
            [34.0000, 105.0000],  // ç»§ç»­åŒ—ä¸Š
            [34.5000, 105.5000],  // é™•è¥¿è¾¹ç•Œ
            [35.0000, 106.0000],  // é™•è¥¿å¢ƒå†…
            [35.5000, 106.5000],  // æ¥è¿‘å´èµ·é•‡
            [36.0000, 107.0000],  // ç»§ç»­å‘å´èµ·é•‡
            [36.5000, 107.5000],  // é™•åŒ—å¢ƒå†…
            [36.92785, 108.17611]  // å´èµ·é•‡ï¼ˆé•¿å¾ç»ˆç‚¹ï¼‰
        ];
        
        // ç»˜åˆ¶çº¢å†›é•¿å¾è·¯çº¿
        var longMarchPath = L.polyline(
            enhancedMarchCoordinates,
            {
                color: '#FFB6C1',  // ç²‰è‰²
                weight: 4,
                opacity: 0.9,
                tooltip: 'çº¢å†›é•¿å¾çœŸå®è·¯çº¿',
                popup: 'çº¢å†›é•¿å¾ï¼ˆ1934-1935ï¼‰ï¼šä»ç‘é‡‘åˆ°å´èµ·é•‡ï¼Œç¿»é›ªå±±è¿‡è‰åœ°çš„çœŸå®è·¯å¾„'
            }
        ).addTo(map);
        
        // åˆ›å»ºèŠ‚ç‚¹æ ‡è®°å’Œä¿¡æ¯
        var markers = [];
        var currentNodeIndex = -1;
        
        for (var i = 0; i < longMarchWaypoints.length; i++) {
            var waypoint = longMarchWaypoints[i];
            
            // åˆ›å»ºè‡ªå®šä¹‰HTMLæ ‡è®°
            var markerHtml = `
            <div style="text-align: center;">
                <div style="
                    position: relative;
                    width: 40px;
                    height: 40px;
                    margin: 0 auto;
                ">
                    <!-- è‡ªå®šä¹‰å›¾æ ‡ -->
                    <div style="
                        background-color: #d32f2f;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        box-shadow: 0 0 10px rgba(211, 47, 47, 0.7);
                    ">ğŸ®</div>
                    <!-- å³ä¸Šè§’æ•°å­— -->
                    <div style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background-color: #ffd700;
                        color: #d32f2f;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
                    ">${i+1}</div>
                </div>
            </div>`;
            
            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
            var customIcon = L.divIcon({
                html: markerHtml,
                className: 'custom-div-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            // åˆ›å»ºæ ‡è®°
            var marker = L.marker(waypoint.location, {
                icon: customIcon,
                title: `${i+1}. ${waypoint.name}`
            }).addTo(map);
            
            // ç»‘å®šå¼¹å‡ºä¿¡æ¯
            marker.bindPopup(`
                <div style="font-size: 14px;">
                    <strong>${waypoint.name}</strong><br>
                    ${waypoint.description}<br>
                    <button onclick="openDetailsForNode(${i})" 
                            style="margin-top: 10px; padding: 5px 10px; 
                                   background-color: #d32f2f; color: white; 
                                   border: none; border-radius: 4px; cursor: pointer;">
                        æŸ¥çœ‹æ›´å¤š
                    </button>
                </div>
            `, {
                maxWidth: 300,
                minWidth: 200
            });
            
            markers.push(marker);
        }
        
        // å…¨å±€å‡½æ•°ï¼šæ‰“å¼€èŠ‚ç‚¹è¯¦æƒ…
        window.openDetailsForNode = function(index) {
            var node = longMarchWaypoints[index];
            
            // æ›´æ–°è¯¦æƒ…é¢æ¿å†…å®¹
            document.getElementById('detail-title').textContent = node.name;
            document.getElementById('detail-description').textContent = node.description;
            document.getElementById('detail-introduction').textContent = node.introduction;
            document.getElementById('detail-events').textContent = node.events;
            document.getElementById('detail-story').textContent = node.story;
            document.getElementById('detail-image').src = node.image;
            document.getElementById('detail-image').alt = node.name + 'å†å²å›¾ç‰‡';
            
            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            var detailsPanel = document.getElementById('details-panel');
            detailsPanel.classList.add('show');
            
            // æ›´æ–°å½“å‰èŠ‚ç‚¹ç´¢å¼•
            currentNodeIndex = index;
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress(index);
            
            // ç§»åŠ¨åœ°å›¾åˆ°è¯¥èŠ‚ç‚¹
            map.setView(node.location, 10);
        };
        
        // å…¨å±€å‡½æ•°ï¼šå…³é—­è¯¦æƒ…é¢æ¿
        window.closeDetails = function() {
            var detailsPanel = document.getElementById('details-panel');
            detailsPanel.classList.remove('show');
        };
        
        // å…¨å±€å‡½æ•°ï¼šä¸Šä¸€ç«™
        window.prevNode = function() {
            if (currentNodeIndex > 0) {
                openDetailsForNode(currentNodeIndex - 1);
            } else if (currentNodeIndex === 0) {
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è·³åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹
                openDetailsForNode(longMarchWaypoints.length - 1);
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œåˆ™ä»ç¬¬ä¸€ä¸ªå¼€å§‹
                openDetailsForNode(0);
            }
        };
        
        // å…¨å±€å‡½æ•°ï¼šä¸‹ä¸€ç«™
        window.nextNode = function() {
            if (currentNodeIndex < longMarchWaypoints.length - 1) {
                openDetailsForNode(currentNodeIndex + 1);
            } else if (currentNodeIndex === longMarchWaypoints.length - 1) {
                // å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è·³åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
                openDetailsForNode(0);
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œåˆ™ä»ç¬¬ä¸€ä¸ªå¼€å§‹
                openDetailsForNode(0);
            }
        };
        
        // å…¨å±€å‡½æ•°ï¼šé‡ç½®åœ°å›¾
        window.resetMap = function() {
            map.setView([25.8856, 116.0270], 8);
            currentNodeIndex = -1;
            updateProgress(-1);
            closeDetails();
        };
        
        // å…¨å±€å‡½æ•°ï¼šåˆ‡æ¢èƒŒæ™¯éŸ³ä¹
        window.toggleAudio = function() {
            var audioBtn = document.getElementById('audio-btn');
            
            if (!window.audio) {
                // åˆ›å»ºéŸ³é¢‘å…ƒç´ 
                window.audio = new Audio('https://assets.mixkit.co/music/preview/mixkit-revolutionary-music-box-649.mp3');
                window.audio.loop = true;
                
                // å°è¯•æ’­æ”¾
                window.audio.play().then(function() {
                    audioBtn.textContent = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
                }).catch(function(error) {
                    console.log('æ— æ³•è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘:', error);
                    alert('è¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾éŸ³ä¹');
                });
            } else {
                if (window.audio.paused) {
                    window.audio.play();
                    audioBtn.textContent = 'æš‚åœèƒŒæ™¯éŸ³ä¹';
                } else {
                    window.audio.pause();
                    audioBtn.textContent = 'æ’­æ”¾èƒŒæ™¯éŸ³ä¹';
                }
            }
        };
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(index) {
            var progressText = document.getElementById('progress-text');
            var progressFill = document.getElementById('progress-fill');
            
            if (index === -1) {
                progressText.textContent = '0%';
                progressFill.style.width = '0%';
            } else {
                var progress = Math.round(((index + 1) / longMarchWaypoints.length) * 100);
                progressText.textContent = progress + '%';
                progressFill.style.width = progress + '%';
            }
        }
        
        // è°ƒæ•´åœ°å›¾é«˜åº¦ä»¥é€‚åº”ç§»åŠ¨è®¾å¤‡
        function adjustMapHeight() {
            var headerHeight = document.getElementById('header-banner').offsetHeight;
            var mapContainer = document.querySelector('.map-container');
            
            mapContainer.style.height = 'calc(100vh - ' + headerHeight + 'px)';
        }
        
        // åˆå§‹åŒ–æ—¶è°ƒæ•´åœ°å›¾é«˜åº¦
        adjustMapHeight();
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´åœ°å›¾é«˜åº¦
        window.addEventListener('resize', adjustMapHeight);
        
        // æ·»åŠ å›¾å±‚æ§åˆ¶å™¨
        L.control.layers({
            'OpenStreetMap': tileLayer,
            'å«æ˜Ÿå›¾': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            })
        }).addTo(map);
        
        // æ·»åŠ æ¯”ä¾‹å°º
        L.control.scale().addTo(map);
        
        // æ·»åŠ åœ°å›¾å›¾ä¾‹
        var legend = L.control({
            position: 'bottomright'
        });
        
        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>å›¾ä¾‹</h4>
                <i style="background: #FFB6C1; width: 20px; height: 3px;"></i> çº¢å†›é•¿å¾è·¯çº¿<br>
                <i style="background: #d32f2f; border-radius: 50%; width: 20px; height: 20px;"></i> é•¿å¾èŠ‚ç‚¹<br>
            `;
            return div;
        };
        
        legend.addTo(map);
    // æ·»åŠ è¡Œèµ°åŠ¨ç”»æ ·å¼
    addWalkingAnimation();
    
    // ä¸ºçº¿æ®µæ·»åŠ åŠ¨ç”»æ•ˆæœ
    setTimeout(animatePaths, 2000);
    
    // æ·»åŠ å¯æ‹–æ‹½çš„å°å£«å…µ
    addSoldier();
    
    // åˆå§‹åŒ–è¿›åº¦
    updateProgress(0);
    
    // ä¸ºåœ°å›¾ä¸Šçš„æ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
    // æ³¨æ„ï¼šè¿™éƒ¨åˆ†éœ€è¦åœ¨åœ°å›¾å®Œå…¨åŠ è½½åæ‰§è¡Œ
    setTimeout(function() {
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            marker.addEventListener('click', function(e) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å¾ªç¯è°ƒç”¨
                e.stopPropagation();
                updateProgress(index);
                // è°ƒç”¨openDetailså‡½æ•°æ‰“å¼€è¯¦æƒ…é¡µ
                openDetails();
                // ç¡®ä¿æµ®çª—èƒ½æ­£ç¡®å¼¹å‡º
                if (marker._icon && marker._icon.parentNode && marker._icon.parentNode._popup) {
                    marker._icon.parentNode.openPopup();
                }
            });
        });
    }, 1000);
    
    // æ·»åŠ CSSæ ·å¼ä½¿è¯¦æƒ…é¢æ¿å¯è§
    setTimeout(function() {
        const style = document.createElement('style');
        style.textContent = `
            #details-panel.show {
                right: 0;
            }
            
            /* çº¢å†›å°äººæ ·å¼ */
            #soldier {
                position: absolute;
                width: 40px;
                height: 60px;
                cursor: move;
                z-index: 999;
                transform-origin: center bottom;
                pointer-events: all;
            }
            
            #soldier.dragging {
                opacity: 0.8;
                transform: scale(1.1);
            }
            
            /* çº¢å†›å°äººè¡Œèµ°åŠ¨ç”» */
            @keyframes walk {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                25% {
                    transform: translateY(-5px) rotate(-3deg);
                }
                50% {
                    transform: translateY(0) rotate(3deg);
                }
                75% {
                    transform: translateY(-5px) rotate(-2deg);
                }
            }
            
            #soldier.walking {
                animation: walk 0.6s infinite ease-in-out;
            }
            
            /* çº¢å†›å°äººç»„ä»¶ */
            .soldier-body {
                position: relative;
                width: 40px;
                height: 60px;
            }
            
            .soldier-head {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 24px;
                height: 24px;
                background-color: #f5d0c5;
                border-radius: 50%;
                border: 2px solid #000;
            }
            
            .soldier-uniform {
                position: absolute;
                top: 24px;
                left: 50%;
                transform: translateX(-50%);
                width: 30px;
                height: 20px;
                background-color: #d32f2f;
                border: 2px solid #000;
            }
            
            .soldier-legs {
                position: absolute;
                top: 44px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 16px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-leg,
            .soldier-right-leg {
                width: 6px;
                height: 16px;
                background-color: #212121;
                border: 1px solid #000;
                position: relative;
            }
            
            .soldier-arms {
                position: absolute;
                top: 28px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 8px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-arm,
            .soldier-right-arm {
                width: 12px;
                height: 8px;
                background-color: #d32f2f;
                border: 1px solid #000;
            }
            
            /* è¡Œèµ°æ—¶çš„æ‰‹è„šåŠ¨ç”» */
            #soldier.walking .soldier-left-leg {
                animation: leg-move 0.6s infinite ease-in-out;
            }
            
            #soldier.walking .soldier-right-leg {
                animation: leg-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-left-arm {
                animation: arm-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-right-arm {
                animation: arm-move 0.6s infinite ease-in-out;
            }
            
            @keyframes leg-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(-20deg);
                }
            }
            
            @keyframes arm-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(20deg);
                }
            }
        `;
        document.head.appendChild(style);
    }, 500);
    
    // æ·»åŠ å¯æ‹–æ‹½çš„å°äºº

    
    // æ·»åŠ è¿›åº¦é¢æ¿å’Œé¡¶éƒ¨æ¨ªå¹…
    function addProgressPanel() {
        // åˆ›å»ºé¡¶éƒ¨æ¨ªå¹…
        const headerBanner = document.createElement('div');
        headerBanner.id = 'header-banner';
        headerBanner.innerHTML = '<h1>çº¢å†›é•¿å¾è·¯çº¿å›¾</h1>';
        document.body.appendChild(headerBanner);
        
        // åˆ›å»ºè¿›åº¦é¢æ¿
        const progressPanel = document.createElement('div');
        progressPanel.id = 'progress-panel';
        
        progressPanel.innerHTML = `
            <h3>é•¿å¾è¿›åº¦</h3>
            <div id="progress-info">
                <div>å·²å®Œæˆ: <span id="progress-text">0%</span></div>
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <div id="current-location">å½“å‰ä½ç½®: èµ·ç‚¹</div>
            </div>
            <button id="prev-btn" class="control-btn">ä¸Šä¸€ç«™</button>
            <button id="next-btn" class="control-btn">ä¸‹ä¸€ç«™</button>
        `;
        
        document.body.appendChild(progressPanel);
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('prev-btn').addEventListener('click', function() {
            prevLocation();
        });
        
        document.getElementById('next-btn').addEventListener('click', function() {
            nextLocation();
        });
        
        // åˆ›å»ºè¯¦æƒ…é¢æ¿
        const detailsPanel = document.createElement('div');
        detailsPanel.id = 'details-panel';
        
        document.body.appendChild(detailsPanel);
        
        // åˆ›å»ºå…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener('click', function() {
            detailsPanel.classList.remove('show');
        });
        
        document.body.appendChild(closeBtn);
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    let currentIndex = 0;
    function updateProgress(index) {
        currentIndex = index;
        const progressText = document.getElementById('progress-text');
        const progressFill = document.getElementById('progress-fill');
        const currentLocation = document.getElementById('current-location');
        
        if (index === 0) {
            progressText.textContent = '0%';
            progressFill.style.width = '0%';
            currentLocation.textContent = 'å½“å‰ä½ç½®: èµ·ç‚¹';
        } else {
            const progress = Math.round((index / (longMarchWaypoints.length - 1)) * 100);
            progressText.textContent = progress + '%';
            progressFill.style.width = progress + '%';
            currentLocation.textContent = 'å½“å‰ä½ç½®: ' + longMarchWaypoints[index - 1].name;
        }
        
        // å¹³æ»‘æ»šåŠ¨åˆ°å¯¹åº”ä½ç½®
        if (index > 0) {
            map.setView([longMarchWaypoints[index - 1].lat, longMarchWaypoints[index - 1].lng], 7);
        } else {
            map.setView([longMarchWaypoints[0].lat, longMarchWaypoints[0].lng], 4);
        }
    }
    
    // ä¸Šä¸€ç«™
    function prevLocation() {
        if (currentIndex > 0) {
            updateProgress(currentIndex - 1);
        }
    }
    
    // ä¸‹ä¸€ç«™
    function nextLocation() {
        if (currentIndex < longMarchWaypoints.length) {
            updateProgress(currentIndex + 1);
        }
    }
    
    // æ·»åŠ è¡Œèµ°åŠ¨ç”»æ ·å¼
    function addWalkingAnimation() {
        const style = document.createElement('style');
        style.textContent = `
            /* è·¯å¾„åŠ¨ç”»æ ·å¼ */
            .path-animation {
                stroke-dasharray: 10;
                animation: dash 30s linear infinite;
            }
            
            @keyframes dash {
                to {
                    stroke-dashoffset: -1000;
                }
            }
            
            /* èŠ‚ç‚¹åŠ¨ç”»æ ·å¼ */
            .node-pulse {
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.7;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // ä¸ºçº¿æ®µæ·»åŠ åŠ¨ç”»æ•ˆæœ
    function animatePaths() {
        const paths = document.querySelectorAll('svg path.leaflet-interactive');
        paths.forEach((path, index) => {
            // æ·»åŠ å»¶è¿Ÿä»¥åˆ›å»ºé¡ºåºåŠ¨ç”»æ•ˆæœ
            setTimeout(() => {
                path.classList.add('path-animation');
            }, index * 500);
        });
        
        // ä¸ºæ ‡è®°æ·»åŠ è„‰å†²åŠ¨ç”»
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            setTimeout(() => {
                const iconElement = marker.querySelector('div');
                if (iconElement) {
                    iconElement.classList.add('node-pulse');
                }
            }, (index + 1) * 800);
        });
    }
    
    // æ‰“å¼€è¯¦æƒ…é¡µ
    function openDetails() {
        const detailsPanel = document.getElementById('details-panel');
        detailsPanel.classList.add('show');
    }
    
    // é•¿å¾èŠ‚ç‚¹è¯¦æƒ…æ•°æ®
    const longMarchDetails = [
        {
            name: "ç‘é‡‘",
            date: "1934å¹´10æœˆ",
            description: "çº¢å†›ä»ç‘é‡‘å‡ºå‘ï¼Œå¼€å§‹äº†ä¸¾ä¸–é—»åçš„äºŒä¸‡äº”åƒé‡Œé•¿å¾ã€‚",
            significance: "é•¿å¾çš„èµ·ç‚¹ï¼Œæ ‡å¿—ç€çº¢å†›æˆ˜ç•¥è½¬ç§»çš„å¼€å§‹ã€‚",
            history: "1934å¹´10æœˆ10æ—¥ï¼Œä¸­å…±ä¸­å¤®ã€ä¸­é©å†›å§”ç‡ä¸­å¤®çº¢å†›ä¸»åŠ›8.6ä¸‡ä½™äººï¼Œä»ç‘é‡‘ç­‰åœ°å‡ºå‘ï¼Œå¼€å§‹é•¿å¾ã€‚",
            image: "https://example.com/ruijin.jpg"
        },
        {
            name: "éµä¹‰ä¼šè®®ä¼šå€",
            date: "1935å¹´1æœˆ",
            description: "éµä¹‰ä¼šè®®ç¡®ç«‹äº†æ¯›æ³½ä¸œåœ¨å…šä¸­å¤®å’Œçº¢å†›çš„é¢†å¯¼åœ°ä½ã€‚",
            significance: "ä¸­å›½å…±äº§å…šå†å²ä¸Šä¸€ä¸ªç”Ÿæ­»æ”¸å…³çš„è½¬æŠ˜ç‚¹ï¼ŒæŒ½æ•‘äº†å…šã€æŒ½æ•‘äº†çº¢å†›ã€æŒ½æ•‘äº†ä¸­å›½é©å‘½ã€‚",
            history: "1935å¹´1æœˆ15æ—¥è‡³17æ—¥ï¼Œä¸­å…±ä¸­å¤®åœ¨éµä¹‰å¬å¼€æ”¿æ²»å±€æ‰©å¤§ä¼šè®®ï¼Œç¡®ç«‹äº†æ¯›æ³½ä¸œåœ¨å…šä¸­å¤®å’Œçº¢å†›çš„é¢†å¯¼åœ°ä½ã€‚",
            image: "https://example.com/zunyi.jpg"
        },
        {
            name: "èµ¤æ°´æ²³ç•”",
            date: "1935å¹´1-3æœˆ",
            description: "å››æ¸¡èµ¤æ°´æˆ˜å½¹æ˜¯æ¯›æ³½ä¸œå†›äº‹æŒ‡æŒ¥è‰ºæœ¯çš„å¾—æ„ä¹‹ä½œã€‚",
            significance: "æ‰“ä¹±äº†å›½æ°‘å…šå†›é˜Ÿçš„è¿½ç¼´è®¡åˆ’ï¼Œå–å¾—äº†æˆ˜ç•¥è½¬ç§»ä¸­å…·æœ‰å†³å®šæ„ä¹‰çš„èƒœåˆ©ã€‚",
            history: "1935å¹´1æœˆ19æ—¥è‡³3æœˆ22æ—¥ï¼Œä¸­å¤®çº¢å†›åœ¨æ¯›æ³½ä¸œç­‰æŒ‡æŒ¥ä¸‹ï¼Œå››æ¸¡èµ¤æ°´ï¼Œå·§å¦™ç©¿æ’äºå›½æ°‘å…šå†›é‡å…µé›†å›¢ä¹‹é—´ã€‚",
            image: "https://example.com/chishui.jpg"
        },
        {
            name: "å·§æ¸¡é‡‘æ²™æ±Ÿ",
            date: "1935å¹´5æœˆ",
            description: "çº¢å†›ä¸è´¹ä¸€æªä¸€å¼¹ï¼Œæ™ºå–é‡‘æ²™æ±Ÿï¼Œæ‘†è„±äº†å‡ åä¸‡å›½æ°‘å…šå†›çš„å›´è¿½å µæˆªã€‚",
            significance: "å®ç°äº†æ¸¡æ±ŸåŒ—ä¸Šçš„æˆ˜ç•¥æ„å›¾ï¼Œå–å¾—äº†æˆ˜ç•¥è½¬ç§»ä¸­å…·æœ‰å†³å®šæ„ä¹‰çš„èƒœåˆ©ã€‚",
            history: "1935å¹´5æœˆ3æ—¥è‡³9æ—¥ï¼Œçº¢å†›ä¸»åŠ›åœ¨7æ¡æœ¨èˆ¹ä¸Šï¼Œç”¨7å¤©7å¤œçš„æ—¶é—´ï¼Œå…¨éƒ¨æ¸¡è¿‡é‡‘æ²™æ±Ÿã€‚",
            image: "https://example.com/jinsha.jpg"
        },
        {
            name: "å¼ºæ¸¡å¤§æ¸¡æ²³",
            date: "1935å¹´5æœˆ",
            description: "çº¢å†›ä»¥æ— æ¯”çš„è‹±å‹‡ç²¾ç¥å¼ºæ¸¡å¤§æ¸¡æ²³ï¼Œé£å¤ºæ³¸å®šæ¡¥ã€‚",
            significance: "æ‰“ç ´äº†è’‹ä»‹çŸ³å¦„å›¾æŠŠçº¢å†›å˜æˆç¬¬äºŒä¸ªçŸ³è¾¾å¼€çš„è¿·æ¢¦ã€‚",
            history: "1935å¹´5æœˆ25æ—¥ï¼Œ17åå‹‡å£«å¼ºæ¸¡å¤§æ¸¡æ²³æˆåŠŸï¼›5æœˆ29æ—¥ï¼Œ22åå‹‡å£«é£å¤ºæ³¸å®šæ¡¥æˆåŠŸã€‚",
            image: "https://example.com/daduhe.jpg"
        },
        {
            name: "ç¿»é›ªå±±ï¼ˆå¤¹é‡‘å±±ï¼‰",
            date: "1935å¹´6æœˆ",
            description: "çº¢å†›å…‹æœäº†éš¾ä»¥æƒ³è±¡çš„å›°éš¾ï¼Œç¿»è¶Šäº†å¤¹é‡‘å±±ã€‚",
            significance: "å±•ç¤ºäº†çº¢å†›ä¸æ€•ç‰ºç‰²ã€ç™¾æŠ˜ä¸æŒ çš„é©å‘½è‹±é›„ä¸»ä¹‰ç²¾ç¥ã€‚",
            history: "1935å¹´6æœˆ12æ—¥ï¼Œçº¢å†›å…ˆå¤´éƒ¨é˜Ÿç¿»è¶Šäº†é•¿å¾é€”ä¸­çš„ç¬¬ä¸€åº§å¤§é›ªå±±â€”â€”å¤¹é‡‘å±±ï¼Œæµ·æ‹”4000å¤šç±³ã€‚",
            image: "https://example.com/jiajinshan.jpg"
        },
        {
            name: "è¿‡è‰åœ°",
            date: "1935å¹´8æœˆ",
            description: "çº¢å†›è¿‡è‰åœ°æ˜¯é•¿å¾ä¸­æœ€è‰°è‹¦çš„ä¸€æ®µè·¯ç¨‹ã€‚",
            significance: "çº¢å†›ä»¥æƒŠäººçš„æ¯…åŠ›ï¼Œæˆ˜èƒœäº†é¥¥é¥¿ã€å¯’å†·ã€ç–¾ç—…å’Œæ­»äº¡çš„å¨èƒã€‚",
            history: "1935å¹´8æœˆ21æ—¥è‡³26æ—¥ï¼Œçº¢å†›å³è·¯å†›ç»è¿‡5å¤©çš„è‰°è‹¦è¡Œå†›ï¼Œèµ°å‡ºäº†çºµæ¨ªæ•°ç™¾é‡Œçš„æ°´è‰åœ°ã€‚",
            image: "https://example.com/caodi.jpg"
        },
        {
            name: "è…Šå­å£æˆ˜å½¹é—å€",
            date: "1935å¹´9æœˆ",
            description: "è…Šå­å£æˆ˜å½¹æ˜¯çº¢å†›é•¿å¾ä¸­çš„ä¸€æ¬¡é‡è¦æˆ˜å½¹ã€‚",
            significance: "æ‰“å¼€äº†çº¢å†›åŒ—ä¸Šè¿›å…¥ç”˜è‚ƒçš„é€šé“ã€‚",
            history: "1935å¹´9æœˆ16æ—¥ï¼Œçº¢å†›å‘èµ·è…Šå­å£æˆ˜å½¹ï¼Œç»è¿‡æ¿€çƒˆæˆ˜æ–—ï¼Œäº17æ—¥æ™¨æ”»å…‹è…Šå­å£ã€‚",
            image: "https://example.com/lazikou.jpg"
        },
        {
            name: "å“ˆè¾¾é“º",
            date: "1935å¹´9æœˆ",
            description: "å“ˆè¾¾é“ºæ˜¯çº¢å†›é•¿å¾ä¸­çš„'åŠ æ²¹ç«™'ã€‚",
            significance: "çº¢å†›åœ¨è¿™é‡Œå¾—åˆ°äº†å®è´µçš„ä¼‘æ•´å’Œè¡¥å……ï¼Œå¹¶ç¡®å®šäº†ç»§ç»­åŒ—ä¸Šçš„æˆ˜ç•¥æ–¹é’ˆã€‚",
            history: "1935å¹´9æœˆ20æ—¥ï¼Œçº¢å†›åˆ°è¾¾å“ˆè¾¾é“ºï¼Œåœ¨è¿™é‡Œè¿›è¡Œäº†ä¼‘æ•´ï¼Œå¹¶é€šè¿‡æŠ¥çº¸äº†è§£åˆ°é™•åŒ—æœ‰çº¢å†›æ ¹æ®åœ°ã€‚",
            image: "https://example.com/hadapu.jpg"
        },
        {
            name: "æ¦œç½—é•‡ä¼šè®®ä¼šå€",
            date: "1935å¹´9æœˆ",
            description: "æ¦œç½—é•‡ä¼šè®®å†³å®šäº†çº¢å†›é•¿å¾çš„æœ€ç»ˆç›®çš„åœ°ã€‚",
            significance: "ç¡®å®šäº†æŠŠä¸­å…±ä¸­å¤®å’Œé™•ç”˜æ”¯é˜Ÿçš„è½è„šç‚¹æ”¾åœ¨é™•åŒ—çš„æˆ˜ç•¥å†³ç­–ã€‚",
            history: "1935å¹´9æœˆ27æ—¥ï¼Œä¸­å…±ä¸­å¤®æ”¿æ²»å±€åœ¨æ¦œç½—é•‡å¬å¼€å¸¸å§”ä¼šè®®ï¼Œå†³å®šæŠŠé•¿å¾çš„è½è„šç‚¹æ”¾åœ¨é™•åŒ—ã€‚",
            image: "https://example.com/bangluozhen.jpg"
        },
        {
            name: "å´èµ·é•‡",
            date: "1935å¹´10æœˆ",
            description: "ä¸­å¤®çº¢å†›åˆ°è¾¾å´èµ·é•‡ï¼Œæ ‡å¿—ç€çº¢ä¸€æ–¹é¢å†›é•¿å¾çš„èƒœåˆ©ç»“æŸã€‚",
            significance: "çº¢ä¸€æ–¹é¢å†›é•¿å¾èƒœåˆ©ç»“æŸï¼Œä¸ºä¸­å›½é©å‘½æ‰“å¼€äº†æ–°å±€é¢ã€‚",
            history: "1935å¹´10æœˆ19æ—¥ï¼Œä¸­å…±ä¸­å¤®å’Œçº¢ä¸€æ–¹é¢å†›åˆ°è¾¾é™•åŒ—å´èµ·é•‡ï¼Œä¸é™•åŒ—çº¢å†›ä¼šå¸ˆã€‚",
            image: "https://example.com/wuqizhen.jpg"
        }
    ];
    
    // æ‰“å¼€èŠ‚ç‚¹è¯¦æƒ…
    function openDetailsForNode(index) {
        const detailsPanel = document.getElementById('details-panel');
        const detail = longMarchDetails[index];
        
        detailsPanel.innerHTML = `
            <h2>${detail.name}</h2>
            <h3>${detail.date}</h3>
            
            <div class="detail-section">
                <h4>ç®€ä»‹</h4>
                <p>${detail.description}</p>
            </div>
            
            <div class="detail-section">
                <h4>å†å²æ„ä¹‰</h4>
                <p>${detail.significance}</p>
            </div>
            
            <div class="detail-section">
                <h4>å†å²èƒŒæ™¯</h4>
                <p>${detail.history}</p>
            </div>
            
            <div class="detail-section">
                <img src="${detail.image}" alt="${detail.name}" style="width: 100%; height: auto; border-radius: 4px;">
            </div>
        `;
        
        detailsPanel.classList.add('show');
    }
    
    // æ·»åŠ å›¾å±‚æ§åˆ¶å™¨
    L.control.layers({
        'OpenStreetMap': tileLayer,
        'å«æ˜Ÿå›¾': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        })
    }).addTo(map);
    
    // æ·»åŠ æ¯”ä¾‹å°º
    L.control.scale().addTo(map);
    
    // æ·»åŠ åœ°å›¾å›¾ä¾‹
    var legend = L.control({
        position: 'bottomright'
    });
    
    legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <h4>å›¾ä¾‹</h4>
            <i style="background: #FFB6C1; width: 20px; height: 3px;"></i> çº¢å†›é•¿å¾è·¯çº¿<br>
            <i style="background: #d32f2f; border-radius: 50%; width: 20px; height: 20px;"></i> é•¿å¾èŠ‚ç‚¹<br>      
        `;
        return div;
    };
    
    legend.addTo(map);
    
    // æ·»åŠ è¡Œèµ°åŠ¨ç”»æ ·å¼
    addWalkingAnimation();
    
    // ä¸ºçº¿æ®µæ·»åŠ åŠ¨ç”»æ•ˆæœ
    setTimeout(animatePaths, 2000);
    
    // æ·»åŠ å¯æ‹–æ‹½çš„å°å£«å…µ
    addSoldier();
    
    // åˆå§‹åŒ–è¿›åº¦
    updateProgress(0);
    
    // ä¸ºåœ°å›¾ä¸Šçš„æ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
    // æ³¨æ„ï¼šè¿™éƒ¨åˆ†éœ€è¦åœ¨åœ°å›¾å®Œå…¨åŠ è½½åæ‰§è¡Œ
    setTimeout(function() {
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            marker.addEventListener('click', function(e) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å¾ªç¯è°ƒç”¨
                e.stopPropagation();
                updateProgress(index);
                // è°ƒç”¨openDetailså‡½æ•°æ‰“å¼€è¯¦æƒ…é¡µ
                openDetails();
                // ç¡®ä¿æµ®çª—èƒ½æ­£ç¡®å¼¹å‡º
                if (marker._icon && marker._icon.parentNode && marker._icon.parentNode._popup) {
                    marker._icon.parentNode.openPopup();
                }
            });
        });
    }, 1000);
    
    // æ·»åŠ CSSæ ·å¼ä½¿è¯¦æƒ…é¢æ¿å¯è§
    setTimeout(function() {
        const style = document.createElement('style');
        style.textContent = `
            #details-panel.show {
                right: 0;
            }
            
            /* çº¢å†›å°äººæ ·å¼ */
            #soldier {
                position: absolute;
                width: 40px;
                height: 60px;
                cursor: move;
                z-index: 999;
                transform-origin: center bottom;
                pointer-events: all;
            }
            
            #soldier.dragging {
                opacity: 0.8;
                transform: scale(1.1);
            }
            
            /* çº¢å†›å°äººè¡Œèµ°åŠ¨ç”» */
            @keyframes walk {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                25% {
                    transform: translateY(-5px) rotate(-3deg);
                }
                50% {
                    transform: translateY(0) rotate(3deg);
                }
                75% {
                    transform: translateY(-5px) rotate(-2deg);
                }
            }
            
            #soldier.walking {
                animation: walk 0.6s infinite ease-in-out;
            }
            
            /* çº¢å†›å°äººç»„ä»¶ */
            .soldier-body {
                position: relative;
                width: 40px;
                height: 60px;
            }
            
            .soldier-head {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 24px;
                height: 24px;
                background-color: #f5d0c5;
                border-radius: 50%;
                border: 2px solid #000;
            }
            
            .soldier-uniform {
                position: absolute;
                top: 24px;
                left: 50%;
                transform: translateX(-50%);
                width: 30px;
                height: 20px;
                background-color: #d32f2f;
                border: 2px solid #000;
            }
            
            .soldier-legs {
                position: absolute;
                top: 44px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 16px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-leg,
            .soldier-right-leg {
                width: 6px;
                height: 16px;
                background-color: #212121;
                border: 1px solid #000;
                position: relative;
            }
            
            .soldier-arms {
                position: absolute;
                top: 28px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 8px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-arm,
            .soldier-right-arm {
                width: 12px;
                height: 8px;
                background-color: #d32f2f;
                border: 1px solid #000;
            }
            
            /* è¡Œèµ°æ—¶çš„æ‰‹è„šåŠ¨ç”» */
            #soldier.walking .soldier-left-leg {
                animation: leg-move 0.6s infinite ease-in-out;
            }
            
            #soldier.walking .soldier-right-leg {
                animation: leg-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-left-arm {
                animation: arm-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-right-arm {
                animation: arm-move 0.6s infinite ease-in-out;
            }
            
            @keyframes leg-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(-20deg);
                }
            }
            
            @keyframes arm-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(20deg);
                }
            }
        `;
        document.head.appendChild(style);
    }, 500);
    
    // æ·»åŠ å¯æ‹–æ‹½çš„å°äºº
    function addSoldier() {
        const soldier = document.createElement('div');
        soldier.id = 'soldier';
        
        // åˆ›å»ºå¸¦æœ‰æ‰‹å’Œè„šçš„å°äººHTMLç»“æ„
        soldier.innerHTML = `
            <div class="soldier-body">
                <div class="soldier-head"></div>
                <div class="soldier-uniform"></div>
                <div class="soldier-arms">
                    <div class="soldier-left-arm"></div>
                    <div class="soldier-right-arm"></div>
                </div>
                <div class="soldier-legs">
                    <div class="soldier-left-leg"></div>
                    <div class="soldier-right-leg"></div>
                </div>
            </div>
        `;
        
        // è®¾ç½®åˆå§‹ä½ç½®
        soldier.style.left = '60px';
        soldier.style.bottom = '60px';
        
        document.body.appendChild(soldier);
        
        let isDragging = false;
        let currentX, currentY, initialX, initialY;
        let pathIndex = -1;
        let isWalking = false;
        let startTime = null;
        let currentProgress = 0;
        let duration = 20000;
        
        // è·å–æ‰€æœ‰è·¯çº¿å…ƒç´ 
        function getPathElements() {
            return document.querySelectorAll('svg path.leaflet-interactive');
        }
        
        // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨è·¯å¾„ä¸Š
        function isPointOnPath(x, y, pathElement) {
            // è·å–SVGå…ƒç´ 
            const svgElement = pathElement.closest('svg');
            if (!svgElement) return false;
            
            const svgRect = svgElement.getBoundingClientRect();
            
            // æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨SVGçŸ©å½¢å†…
            if (x < svgRect.left - 10 || x > svgRect.right + 10 || y < svgRect.top - 10 || y > svgRect.bottom + 10) {
                return false;
            }
            
            try {
                // è·å–SVGçš„CTM(Current Transformation Matrix)ä»¥å°†å±å¹•åæ ‡è½¬æ¢ä¸ºSVGåæ ‡
                const point = svgElement.createSVGPoint();
                point.x = x;
                point.y = y;
                
                // è·å–SVGå…ƒç´ çš„åæ ‡ç³»ä¸­çš„ç‚¹
                const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                
                // ä½¿ç”¨isPointInStrokeå’ŒisPointInFillæ¥æ£€æµ‹ç‚¹æ˜¯å¦åœ¨çº¿ä¸Š
                const isInStroke = pathElement.isPointInStroke(transformedPoint);
                const isInFill = pathElement.isPointInFill(transformedPoint);
                
                // ä½¿ç”¨getPointAtLengthè¿›è¡Œæ›´ç²¾ç¡®çš„æ£€æµ‹
                const pathLength = pathElement.getTotalLength();
                
                // å¢åŠ é‡‡æ ·å¯†åº¦ä»¥æé«˜æ£€æµ‹ç²¾åº¦
                for (let i = 0; i <= pathLength; i += 1) {
                    const pathPoint = pathElement.getPointAtLength(i);
                    const distance = Math.sqrt(
                        Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                        Math.pow(transformedPoint.y - pathPoint.y, 2)
                    );
                    
                    // æ‰©å¤§æ£€æµ‹èŒƒå›´åˆ°20åƒç´ ä»¥æé«˜æˆåŠŸç‡
                    if (distance < 20) {
                        return true;
                    }
                }
                
                return isInStroke || isInFill;
            } catch (error) {
                console.error('æ£€æµ‹è·¯å¾„ç‚¹å‡ºé”™:', error);
                return false;
            }
        }
        
        // æ‰¾åˆ°å°å£«å…µæ‰€åœ¨çš„è·¯å¾„ç´¢å¼•
        function findPathIndex(x, y) {
            const paths = getPathElements();
            for (let i = 0; i < paths.length; i++) {
                // ç›´æ¥ä¼ é€’ç»å¯¹åæ ‡ç»™isPointOnPath
                if (isPointOnPath(x, y, paths[i])) {
                    console.log('æ‰¾åˆ°è·¯å¾„ç´¢å¼•:', i);
                    return i;
                }
            }
            console.log('æœªæ‰¾åˆ°è·¯å¾„');
            return -1;
        }
        
        // æ‰¾åˆ°ç‚¹åœ¨è·¯å¾„ä¸Šçš„æœ€è¿‘ä½ç½®ï¼Œå¹¶è¿”å›è¿›åº¦å€¼(0-1)
        function findClosestPointOnPath(x, y, pathElement) {
            const svgElement = pathElement.closest('svg');
            if (!svgElement) return -1;
            
            try {
                const point = svgElement.createSVGPoint();
                point.x = x;
                point.y = y;
                
                const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                const pathLength = pathElement.getTotalLength();
                
                let minDistance = Infinity;
                let closestPointIndex = 0;
                
                // åœ¨è·¯å¾„ä¸Šé‡‡æ ·æ›´å¤šç‚¹ä»¥æ‰¾åˆ°æœ€è¿‘ç‚¹
                for (let i = 0; i <= pathLength; i += 5) {
                    const pathPoint = pathElement.getPointAtLength(i);
                    const distance = Math.sqrt(
                        Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                        Math.pow(transformedPoint.y - pathPoint.y, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPointIndex = i;
                    }
                }
                
                // åªæœ‰å½“æœ€è¿‘ç‚¹è¶³å¤Ÿè¿‘æ—¶æ‰è¿”å›è¿›åº¦å€¼
                if (minDistance < 30) {
                    return closestPointIndex / pathLength;
                }
                
                return -1;
            } catch (error) {
                console.error('è®¡ç®—è·¯å¾„æœ€è¿‘ç‚¹å‡ºé”™:', error);
                return -1;
            }
        }
        
        // æ²¿è·¯å¾„ç§»åŠ¨å°äºº
        function moveAlongPath(pathIndex, duration = 20000, startPosition = null) { // å‡æ…¢é€Ÿåº¦ä¸º20ç§’
            const paths = getPathElements();
            if (pathIndex < 0 || pathIndex >= paths.length) return;
            
            // å¼€å§‹è¡Œèµ°åŠ¨ç”»
            isWalking = true;
            soldier.classList.add('walking');
            
            const path = paths[pathIndex];
            const pathLength = path.getTotalLength();
            let startTime = null;
            let currentProgress = 0; // ä¿å­˜å½“å‰è¡Œèµ°è¿›åº¦
            
            // å¦‚æœæä¾›äº†èµ·å§‹ä½ç½®ï¼ˆæ‹–æ‹½é‡Šæ”¾çš„ä½ç½®ï¼‰ï¼Œè®¡ç®—åœ¨è·¯å¾„ä¸Šçš„è¿›åº¦
            if (startPosition) {
                const progress = findClosestPointOnPath(startPosition.x, startPosition.y, path);
                if (progress >= 0) {
                    currentProgress = progress;
                    console.log('ä»æ‹–æ‹½ä½ç½®å¼€å§‹ç§»åŠ¨ï¼Œè¿›åº¦:', currentProgress);
                }
            }
            
            function move(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = currentProgress + (timestamp - startTime) / duration;
                
                if (progress < 1 && isWalking) {
                    const point = path.getPointAtLength(progress * pathLength);
                    
                    // è·å–åœ°å›¾å®¹å™¨ä½ç½®
                    const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
                    if (!mapContainer) {
                        console.error('åœ°å›¾å®¹å™¨æœªæ‰¾åˆ°');
                        return;
                    }
                    
                    const mapRect = mapContainer.getBoundingClientRect();
                    const svgElement = path.closest('svg');
                    
                    if (svgElement) {
                        const svgRect = svgElement.getBoundingClientRect();
                        
                        // ä¿®å¤è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿å°äººå‡†ç¡®æ²¿ç€è·¯çº¿è¡Œèµ°
                        const mapX = point.x + svgRect.left - mapRect.left - 20; // å‡å»å°äººå®½åº¦çš„ä¸€åŠä½¿å…¶å±…ä¸­
                        const mapY = point.y + svgRect.top - mapRect.top - 28; // è°ƒæ•´å‚ç›´ä½ç½®ï¼Œç¡®ä¿è„šè¸©åœ¨çº¿ä¸Š
                        
                        // ç¡®ä¿ä½ç½®åœ¨åˆç†èŒƒå›´å†…ï¼Œé˜²æ­¢å°äººæ¶ˆå¤±
                        const containerWidth = mapContainer.offsetWidth;
                        const containerHeight = mapContainer.offsetHeight;
                        const soldierWidth = 40;
                        const soldierHeight = 60;
                        
                        // é™åˆ¶å°äººåœ¨åœ°å›¾å®¹å™¨å†…
                        const safeX = Math.max(0, Math.min(mapX, containerWidth - soldierWidth));
                        const safeY = Math.max(0, Math.min(mapY, containerHeight - soldierHeight));
                        
                        // è®¾ç½®å°äººä½ç½®ï¼ˆç›¸å¯¹äºåœ°å›¾å®¹å™¨ï¼‰
                        soldier.style.position = 'absolute';
                        soldier.style.left = safeX + 'px';
                        soldier.style.top = safeY + 'px';
                        soldier.style.bottom = 'auto';
                        
                        // ç¡®ä¿å°äººå§‹ç»ˆæ˜¾ç¤ºåœ¨åœ°å›¾ä¸Šæ–¹
                        soldier.style.zIndex = '999';
                        
                        // ç¡®ä¿å°äººå…ƒç´ æ˜¯å¯è§çš„
                        soldier.style.display = 'block';
                    }
                    
                    // ç¡®ä¿åŠ¨ç”»æŒç»­è¿›è¡Œ
                    if (typeof window.requestAnimationFrame === 'function') {
                        requestAnimationFrame(move);
                    } else {
                        // é™çº§æ–¹æ¡ˆ - ä½¿ç”¨setTimeoutä½œä¸ºåå¤‡
                        setTimeout(() => move(Date.now()), 16); // çº¦60fps
                    }
                } else {
                    // ç§»åŠ¨ç»“æŸ
                    isWalking = false;
                    soldier.classList.remove('walking');
                    
                    // ç§»åŠ¨åˆ°ä¸‹ä¸€ç«™
                    currentNodeIndex = Math.min(currentNodeIndex + 1, totalNodes - 1);
                    updateProgress(currentNodeIndex);
                    
                    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹
                    if (currentNodeIndex >= totalNodes - 1) {
                        // å»¶è¿Ÿ3ç§’åè¿”å›ç•Œé¢å·¦ä¸‹æ–¹
                        setTimeout(() => {
                            // é‡ç½®ä½ç½®åˆ°ç•Œé¢å·¦ä¸‹æ–¹
                            resetSoldierPosition();
                        }, 3000);
                    }
                }
            }
            
            // ç¡®ä¿åŠ¨ç”»å¼€å§‹ï¼Œå¹¶é‡ç½®startTimeç¡®ä¿ä»è·¯å¾„èµ·ç‚¹å¼€å§‹
            startTime = null;
            if (typeof window.requestAnimationFrame === 'function') {
                requestAnimationFrame(move);
            } else {
                // é™çº§æ–¹æ¡ˆ
                move(Date.now());
            }
            console.log('å¼€å§‹æ²¿è·¯å¾„ç§»åŠ¨å°äººï¼Œè·¯å¾„ç´¢å¼•:', pathIndex);
        }
        
        // é‡ç½®å°äººåˆ°ç•Œé¢å·¦ä¸‹æ–¹
        function resetSoldierPosition() {
            // ç¡®ä¿åœ°å›¾å®¹å™¨å­˜åœ¨
            const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
            if (!mapContainer) {
                console.error('åœ°å›¾å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            // åœæ­¢ä»»ä½•è¡Œèµ°åŠ¨ç”»
            isWalking = false;
            soldier.classList.remove('walking');
            
            // é‡ç½®åˆ°ç•Œé¢å·¦ä¸‹æ–¹ï¼Œä½¿ç”¨ç›¸å¯¹å®šä½ä»¥é¿å…å—åˆ°åœ°å›¾ç¼©æ”¾å½±å“
            soldier.style.position = 'absolute';
            soldier.style.left = '60px';
            soldier.style.bottom = '60px';
            soldier.style.top = 'auto';
            
            // ç¡®ä¿å°äººå¯è§
            soldier.style.zIndex = '999';
            soldier.style.display = 'block';
            
            // é‡ç½®è·¯å¾„ç´¢å¼•
            pathIndex = -1;
            
            console.log('å°äººå·²é‡ç½®åˆ°ç•Œé¢å·¦ä¸‹æ–¹');
        }
            
        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        soldier.addEventListener('mousedown', function(e) {
            // åœæ­¢è¡Œèµ°åŠ¨ç”»
            if (isWalking) {
                isWalking = false;
                soldier.classList.remove('walking');
            }
            
            initialX = e.clientX;
            initialY = e.clientY;
            isDragging = true;
            soldier.classList.add('dragging');
            
            // æ”¹å˜ä¸ºå›ºå®šå®šä½ä»¥ä¾¿æ‹–æ‹½
            soldier.style.position = 'fixed';
        });
            
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                initialX = e.clientX;
                initialY = e.clientY;
                
                const newLeft = parseInt(soldier.style.left || '60px') + currentX;
                const newBottom = parseInt(soldier.style.bottom || '60px') - currentY;
                
                // é™åˆ¶åœ¨è§†å£å†…
                if (newLeft > 0 && newLeft < window.innerWidth - 40) {
                    soldier.style.left = newLeft + 'px';
                }
                if (newBottom > 0 && newBottom < window.innerHeight - 40) {
                    soldier.style.bottom = newBottom + 'px';
                }
            }
        });
            
        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                soldier.classList.remove('dragging');
                
                // è·å–å°äººä¸­å¿ƒç‚¹åæ ‡
                const rect = soldier.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                // å¯»æ‰¾æ‰€æœ‰è·¯å¾„ä¸­æœ€è¿‘çš„ç‚¹ï¼Œæ— è®ºæ˜¯å¦åœ¨è·¯å¾„ä¸Š
                let closestPathIndex = -1;
                let closestProgress = -1;
                let minDistance = Infinity;
                const paths = getPathElements();
                
                // éå†æ‰€æœ‰è·¯å¾„æ‰¾åˆ°æœ€è¿‘çš„ç‚¹
                for (let i = 0; i < paths.length; i++) {
                    const path = paths[i];
                    const svgElement = path.closest('svg');
                    if (!svgElement) continue;
                    
                    try {
                        const point = svgElement.createSVGPoint();
                        point.x = x;
                        point.y = y;
                        
                        const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                        const pathLength = path.getTotalLength();
                        let pathMinDistance = Infinity;
                        let closestPointIndex = 0;
                        
                        // åœ¨è·¯å¾„ä¸Šé‡‡æ ·æ›´å¤šç‚¹ä»¥æ‰¾åˆ°æœ€è¿‘ç‚¹
                        for (let j = 0; j <= pathLength; j += 2) { // å¢åŠ é‡‡æ ·å¯†åº¦
                            const pathPoint = path.getPointAtLength(j);
                            const distance = Math.sqrt(
                                Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                                Math.pow(transformedPoint.y - pathPoint.y, 2)
                            );
                            
                            if (distance < pathMinDistance) {
                                pathMinDistance = distance;
                                closestPointIndex = j;
                            }
                        }
                        
                        // æ‰¾åˆ°æ­¤è·¯å¾„ä¸Šçš„æœ€è¿‘ç‚¹
                        if (pathMinDistance < minDistance) {
                            minDistance = pathMinDistance;
                            closestPathIndex = i;
                            closestProgress = closestPointIndex / pathLength;
                        }
                    } catch (error) {
                        console.error('è®¡ç®—è·¯å¾„æœ€è¿‘ç‚¹å‡ºé”™:', error);
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°è¶³å¤Ÿè¿‘çš„è·¯å¾„ï¼ˆè·ç¦»é˜ˆå€¼è®¾ä¸º60åƒç´ ï¼‰
                if (closestPathIndex !== -1 && minDistance < 60) {
                    pathIndex = closestPathIndex;
                    
                    // è·å–å¯¹åº”çš„è·¯å¾„å…ƒç´ 
                    const path = paths[pathIndex];
                    
                    // å°†å°äººä½ç½®è½¬æ¢ä¸ºç›¸å¯¹äºåœ°å›¾å®¹å™¨çš„åæ ‡
                    const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
                    if (mapContainer) {
                        const mapRect = mapContainer.getBoundingClientRect();
                        const svgElement = path.closest('svg');
                        
                        if (svgElement) {
                            const svgRect = svgElement.getBoundingClientRect();
                            
                            // ç«‹å³å°†å°äººå®šä½åˆ°è·¯å¾„ä¸Šçš„ç²¾ç¡®ä½ç½®
                            const point = path.getPointAtLength(closestProgress * path.getTotalLength());
                            const mapX = point.x + svgRect.left - mapRect.left - 20;
                            const mapY = point.y + svgRect.top - mapRect.top - 28;
                            
                            // è®¾ç½®ä½ç½®
                            soldier.style.position = 'absolute';
                            soldier.style.left = mapX + 'px';
                            soldier.style.top = mapY + 'px';
                            soldier.style.bottom = 'auto';
                            soldier.style.zIndex = '999';
                            soldier.style.display = 'block';
                            
                            // ä»è¯¥ä½ç½®å¼€å§‹æ²¿è·¯å¾„ç§»åŠ¨
                            moveAlongPath(pathIndex, 20000, {x: mapX + 20, y: mapY + 28});
                        }
                    }
                } else {
                    // å¦‚æœä¸åœ¨ä»»ä½•è·¯çº¿é™„è¿‘ï¼Œç¡®ä¿å°äººä¸ä¼šæ¶ˆå¤±
                    soldier.style.display = 'block';
                    soldier.style.zIndex = '999';
                }
            }
        });
            
        // ç›‘å¬åœ°å›¾æ‹–åŠ¨äº‹ä»¶ï¼Œç¡®ä¿å°äººåœ¨è¡Œèµ°æ—¶ä¸å—å½±å“
        const map = getMap();
        if (map) {
            map.on('dragstart', function() {
                if (isWalking) {
                    // ä¿å­˜å½“å‰ä½ç½®
                    const rect = soldier.getBoundingClientRect();
                    const mapContainer = document.querySelector('.map-container, .folium-map');
                    const mapRect = mapContainer.getBoundingClientRect();
                    
                    // ä¿å­˜å½“å‰è¿›åº¦
                    if (startTime) {
                        const elapsedTime = Date.now() - startTime;
                        currentProgress = Math.min(elapsedTime / duration, 1);
                    }
                    
                    // è½¬æ¢ä¸ºç›¸å¯¹äºåœ°å›¾çš„ä½ç½®
                    soldier.style.position = 'absolute';
                    soldier.style.left = (rect.left - mapRect.left) + 'px';
                    soldier.style.top = (rect.top - mapRect.top) + 'px';
                    soldier.style.bottom = 'auto';
                }
            });
            
            map.on('dragend', function() {
                if (isWalking) {
                    // ç»§ç»­è¡Œèµ°åŠ¨ç”»ï¼Œä»ä¿å­˜çš„è¿›åº¦ç»§ç»­
                    if (pathIndex !== -1) {
                        // é‡ç½®startTimeä½†ä¿ç•™è¿›åº¦
                        startTime = null;
                        if (typeof window.requestAnimationFrame === 'function') {
                            requestAnimationFrame(move);
                        } else {
                            move(Date.now());
                        }
                    }
                }
            });
        }
    }
    
    // åˆå§‹åŒ–æ·»åŠ è¿›åº¦é¢æ¿
    addProgressPanel();
</script>
</body>
</html>