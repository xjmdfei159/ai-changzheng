<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <div id="map-id" style="display: none;">map</div>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_1847de95be0bd1ebe87a3dd0366aead5 {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

            <!-- 添加自定义CSS和JavaScript来实现界面增强 -->
            <style>
                /* 左侧悬浮窗样式 */
                #progress-panel {
                    position: fixed;
                    left: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 150px;
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #progress-panel h3 {
                    margin-top: 0;
                    margin-bottom: 10px;
                    font-size: 16px;
                    color: #d32f2f;
                    text-align: center;
                }
                
                #progress-info {
                    margin-bottom: 15px;
                    text-align: center;
                }
                
                #progress-bar {
                    width: 100%;
                    height: 8px;
                    background: #e0e0e0;
                    border-radius: 4px;
                    margin: 10px 0;
                    overflow: hidden;
                }
                
                #progress-fill {
                    height: 100%;
                    background: #d32f2f;
                    width: 0%;
                    transition: width 0.3s ease;
                }
                
                .control-btn {
                    width: 100%;
                    padding: 8px;
                    margin: 5px 0;
                    background: #d32f2f;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                }
                
                .control-btn:hover {
                    background: #b71c1c;
                }
                
                /* 顶部标志样式 */
                #header-banner {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 60px;
                    background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                    z-index: 1001;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #header-banner h1 {
                    margin: 0;
                    font-size: 24px;
                    font-weight: bold;
                }
                
                /* 右侧详情页样式 */
                #details-panel {
                    position: fixed;
                    right: -400px;
                    top: 60px;
                    bottom: 0;
                    width: 400px;
                    background: rgba(255, 255, 255, 0.95);
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    transition: right 0.3s ease;
                    padding: 20px;
                    overflow-y: auto;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                }
                
                #details-panel.show {
                    right: 0;
                }
                
                #details-panel h2 {
                    margin-top: 0;
                    color: #d32f2f;
                    font-size: 20px;
                }
                
                #details-panel h3 {
                    color: #757575;
                    font-size: 16px;
                    margin-top: 5px;
                }
                
                .detail-section {
                    margin-bottom: 20px;
                }
                
                .detail-section h4 {
                    color: #333;
                    font-size: 14px;
                    margin-bottom: 8px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #e0e0e0;
                }
                
                .detail-section p {
                    line-height: 1.6;
                    color: #555;
                    margin: 0;
                }
                
                .close-btn {
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    width: 30px;
                    height: 30px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1002;
                    color: #333;
                    font-size: 20px;
                    line-height: 1;
                    padding: 0;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                }
                
                .close-btn:hover {
                    opacity: 0.8;
                }
                
                /* 确保地图容器有足够的空间显示所有内容 */
                .map-container {
                    position: relative;
                    width: 100%;
                    height: 100vh;
                }
                
                /* 音效控制样式 */
                #audio-control {
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid #e0e0e0;
                }
                
                #audio-btn {
                    width: 100%;
                    padding: 8px;
                    background: #2196f3;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                }
                
                #audio-btn:hover {
                    background: #1976d2;
                }
                
                /* 地图图例样式 */
                .legend {
                    background: white;
                    padding: 10px;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    font-size: 12px;
                    line-height: 1.5;
                }
                
                .legend i {
                    width: 15px;
                    height: 15px;
                    float: left;
                    margin-right: 8px;
                    opacity: 0.8;
                }
            </style>
        </head>
<body>
    <!-- 顶部标志 -->
    <div id="header-banner">
        <h1>红军长征路线图</h1>
    </div>
    
    <!-- 左侧悬浮窗 -->
    <div id="progress-panel">
        <h3>长征进度</h3>
        <div id="progress-info">
            <div>已完成: <span id="progress-text">0%</span></div>
            <div id="progress-bar">
                <div id="progress-fill"></div>
            </div>
        </div>
        <button class="control-btn" onclick="prevNode()">上一站</button>
        <button class="control-btn" onclick="nextNode()">下一站</button>
        <button class="control-btn" onclick="resetMap()">重置地图</button>
        
        <!-- 音效控制 -->
        <div id="audio-control">
            <button id="audio-btn" onclick="toggleAudio()">播放背景音乐</button>
        </div>
    </div>
    
    <!-- 右侧详情面板 -->
    <div id="details-panel">
        <h2 id="detail-title">站点详情</h2>
        <h3 id="detail-description"></h3>
        
        <div class="detail-section">
            <h4>地点介绍</h4>
            <p id="detail-introduction"></p>
        </div>
        
        <div class="detail-section">
            <h4>主要事件</h4>
            <p id="detail-events"></p>
        </div>
        
        <div class="detail-section">
            <h4>历史故事</h4>
            <p id="detail-story"></p>
        </div>
        
        <div class="detail-section">
            <img id="detail-image" src="" alt="历史图片" style="width: 100%; border-radius: 4px; margin-top: 10px;">
        </div>
    </div>
    
    <!-- 关闭按钮 -->
    <button class="close-btn" onclick="closeDetails()">×</button>
    
    <!-- 地图容器 -->
    <div class="map-container">
        <div id="map"></div>
    </div>
    
    <script>
        // 创建地图实例
        var map = L.map('map').setView([25.8856, 116.0270], 8);
        
        // 添加基础图层
        var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // 长征路线节点数据
        var longMarchWaypoints = [
            {
                name: '瑞金',
                location: [25.8856, 116.0270],
                description: '长征出发地',
                introduction: '瑞金是中华苏维埃共和国临时中央政府所在地，被誉为红色故都、共和国摇篮。',
                events: '1934年10月10日，中共中央、中革军委率中央红军主力从瑞金等地出发，开始长征。',
                story: '1934年10月，由于第五次反"围剿"失败，中央红军被迫实行战略性转移。在瑞金，红军进行了充分的准备，包括人员、物资的集结和政治动员。红军将士们怀着对革命事业的坚定信念，踏上了艰苦卓绝的长征之路。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/e3b61520c2e4f516b1c4651f4691815d.jpeg'
            },
            {
                name: '雩都',
                location: [25.9811, 115.4442],
                description: '于都河渡河',
                introduction: '雩都（今于都）是中央红军长征的第一渡，是红军离开中央苏区的最后一站。',
                events: '1934年10月16日至19日，中央红军主力8.6万余人从于都河的8个渡口渡河，开始了著名的二万五千里长征。',
                story: '在于都，当地群众积极支持红军，他们不仅提供了大量的船只，还帮助红军搭建浮桥。许多群众自发为红军战士送茶送水，甚至把自己的口粮拿出来支援红军。在群众的帮助下，红军成功渡过了于都河，开始了艰苦的长征历程。',
                image: 'https://img.zcool.cn/community/01b4d45d383265a8012193a3696d2e.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: '遵义',
                location: [27.7172, 106.9271],
                description: '遵义会议召开地',
                introduction: '遵义是中国革命历史上的重要转折点，遵义会议确立了毛泽东在党中央和红军的领导地位。',
                events: '1935年1月15日至17日，中共中央在遵义召开政治局扩大会议，确立了毛泽东在党中央和红军的领导地位。',
                story: '遵义会议是中国共产党历史上一个生死攸关的转折点。会议集中解决了当时具有决定意义的军事和组织问题，结束了王明"左"倾教条主义在党中央的统治，确立了毛泽东在党中央和红军的领导地位。这次会议挽救了党、挽救了红军、挽救了中国革命，是党的历史上一个伟大的转折点。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/b3bd8b8d9bceb918e1421e11b91a8d83.jpeg'
            },
            {
                name: '赤水',
                location: [28.5081, 105.7975],
                description: '四渡赤水',
                introduction: '赤水是红军长征中著名的四渡赤水战役发生地，是毛泽东军事指挥艺术的得意之笔。',
                events: '1935年1月19日至3月22日，中央红军在毛泽东等指挥下，四渡赤水，巧妙地跳出了国民党军的包围圈。',
                story: '四渡赤水战役是红军长征中最精彩的军事行动之一，也是毛泽东军事指挥艺术的得意之笔。在毛泽东的指挥下，红军采取灵活机动的战略战术，声东击西，迷惑敌人，成功地摆脱了国民党军的围追堵截，实现了战略转移的目标。',
                image: 'https://img.zcool.cn/community/01f02858a471e7a801219c77d2e322.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: '金沙江',
                location: [27.1564, 100.2562],
                description: '巧渡金沙江',
                introduction: '金沙江是长江的上游，水流湍急，是红军长征中的一道天险。',
                events: '1935年5月3日至9日，中央红军干部团在后有追兵的情况下，仅凭7只小船，用6天6夜时间巧渡金沙江。',
                story: '金沙江战役是红军长征中的一次重要战役。红军先头部队化装成国民党军，智取了皎平渡，并控制了渡口。当地群众帮助红军仅用7只小船，在6天6夜时间里，将中央红军主力全部渡过了金沙江，成功地摆脱了国民党军的围追堵截。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/a6a3b39b0bbd5f2f1ce3d1b1f8e28d8e.jpeg'
            },
            {
                name: '大渡河',
                location: [29.4333, 102.2167],
                description: '强渡大渡河',
                introduction: '大渡河是红军长征中的又一道天险，水流湍急，两岸悬崖峭壁。',
                events: '1935年5月24日至25日，中央红军在安顺场强渡大渡河，十八勇士冒着敌人的枪林弹雨，成功突破天险。',
                story: '强渡大渡河是红军长征中的一次勇敢壮举。在敌人的严密防守下，红军十八勇士在火力掩护下，乘坐木船强行渡河，成功地突破了敌人的防线。这次战役展现了红军战士不怕牺牲、英勇无畏的革命精神。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/a40e6c959663850777e278d9cf295be2.jpeg'
            },
            {
                name: '泸定桥',
                location: [29.9428, 102.2956],
                description: '飞夺泸定桥',
                introduction: '泸定桥是一座铁索桥，横跨大渡河，是红军长征中的关键节点。',
                events: '1935年5月29日，22名红军战士在火力掩护下，攀着铁索向对岸冲锋，最终夺下泸定桥。',
                story: '飞夺泸定桥是红军长征中最惊险、最悲壮的战役之一。在敌人拆除了桥上的木板，只剩下13根铁索的情况下，22名红军战士手持冲锋枪，身背马刀，腰缠手榴弹，冒着敌人的枪林弹雨，攀着铁索向对岸冲锋。最终，红军成功地夺下了泸定桥，为中央红军北上打开了通道。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/35e4fbd5b33c4307160c507a8133afb1.jpeg'
            },
            {
                name: '夹金山',
                location: [30.6853, 102.8677],
                description: '翻越夹金山',
                introduction: '夹金山是红军长征中翻越的第一座大雪山，海拔4000多米，山上终年积雪，空气稀薄。',
                events: '1935年6月12日，中央红军先头部队翻越长征途中第一座大雪山——夹金山，山上终年积雪，空气稀薄。',
                story: '翻越夹金山是红军长征中的一次艰苦卓绝的考验。山上终年积雪，空气稀薄，气温极低，许多红军战士因为严寒、缺氧而牺牲。但红军战士们发扬了不怕苦、不怕死的革命精神，互相帮助，互相鼓励，最终成功地翻越了夹金山。',
                image: 'https://img.zcool.cn/community/01611d58a471e9a801219c77557881.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: '懋功',
                location: [31.5543, 102.4531],
                description: '与红四方面军会师',
                introduction: '懋功是中央红军与红四方面军会师的地点，标志着红军力量的壮大。',
                events: '1935年6月18日，中央红军与红四方面军在懋功会师，两军将士欢欣鼓舞，庆祝胜利会师。',
                story: '懋功会师是红军长征中的一个重要里程碑。中央红军与红四方面军的胜利会师，壮大了红军的力量，增强了红军的信心。两军将士互相学习，互相帮助，结下了深深的革命友谊。',
                image: 'https://img.zcool.cn/community/015c5558a471e8a801219c779f01fc.jpg@1280w_1l_2o_100sh.jpg'
            },
            {
                name: '松潘草地',
                location: [32.6000, 103.8000],
                description: '过草地',
                introduction: '松潘草地是红军长征中最艰苦的路段之一，到处是沼泽泥潭，一不小心就会陷进去。',
                events: '1935年8月21日至26日，中央红军过松潘草地，草地茫茫无边，到处是沼泽泥潭，不少红军战士陷入泥潭牺牲。',
                story: '过草地是红军长征中最艰苦的历程之一。草地茫茫无边，到处是沼泽泥潭，一不小心就会陷进去，而且没有食物，没有水，许多红军战士因为饥饿、寒冷、疾病而牺牲。但红军战士们发扬了革命乐观主义精神，互相帮助，互相鼓励，最终成功地走出了草地。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/ce287241f06b1665e6b1fc778a7fb59d.jpeg'
            },
            {
                name: '吴起镇',
                location: [36.92785, 108.17611],
                description: '长征终点',
                introduction: '吴起镇是中央红军长征的终点，标志着长征的胜利结束。',
                events: '1935年10月19日，中央红军到达陕北吴起镇，与陕北红军会师，胜利完成了二万五千里长征。',
                story: '吴起镇会师是红军长征胜利的标志。经过一年多的艰苦跋涉，中央红军终于到达了陕北，与陕北红军胜利会师。长征的胜利，保存了党和红军的基干力量，打开了中国革命的新局面。',
                image: 'https://pic.rmb.bdstatic.com/bjh/news/18afdc74229304940c6cf7756957d376.jpeg'
            }
        ];
        
        // 增强版长征路线坐标
        var enhancedMarchCoordinates = [
            // 瑞金到雩都段
            [25.8856, 116.0270],  // 瑞金
            [25.9250, 115.8700],  // 于都河渡口附近
            [25.9811, 115.4442],  // 雩都
            
            // 雩都到遵义段
            [25.9000, 114.9000],  // 向湘江方向
            [25.6000, 113.9000],  // 湘江战役附近
            [26.0000, 113.0000],  // 贵州边界
            [26.5000, 111.8000],  // 贵州境内
            [27.1000, 109.8000],  // 接近遵义
            [27.7172, 106.9271],  // 遵义
            
            // 遵义到赤水段
            [27.8000, 106.5000],  // 遵义附近
            [28.0000, 106.2000],  // 四渡赤水路线点1
            [28.2000, 105.9000],  // 四渡赤水路线点2
            [28.4000, 105.8000],  // 四渡赤水路线点3
            [28.5081, 105.7975],  // 赤水
            
            // 赤水到金沙江段
            [28.3000, 105.2000],  // 向金沙江方向
            [27.9000, 104.5000],  // 云南境内
            [27.5000, 103.2000],  // 接近金沙江
            [27.1564, 100.2562],  // 金沙江
            
            // 金沙江到大渡河段
            [27.5000, 100.0000],  // 继续北上
            [28.0000, 101.0000],  // 四川境内
            [28.8000, 101.8000],  // 接近大渡河
            [29.4333, 102.2167],  // 大渡河
            
            // 大渡河到泸定桥段
            [29.6000, 102.2500],  // 向泸定桥方向
            [29.9428, 102.2956],  // 泸定桥
            
            // 泸定桥到懋功段（简化，不再显示具体雪山位置）
            [30.1000, 102.4000],  // 向西北方向
            [30.5000, 102.6000],  // 继续北上
            [31.0000, 102.5000],  // 继续北上
            [31.3000, 102.4500],  // 接近懋功
            [31.5543, 102.4531],  // 懋功（与红四方面军会师）
            
            // 懋功到吴起镇段（简化松潘草地路线）
            [31.8000, 102.8000],  // 向松潘草地方向
            [32.0000, 103.0000],  // 松潘草地附近
            [32.3000, 103.4000],  // 松潘草地北部
            [32.6047, 103.6553],  // 松潘草地（更精确的坐标）
            [33.0000, 104.0000],  // 离开草地
            [33.5000, 104.5000],  // 甘肃境内
            [34.0000, 105.0000],  // 继续北上
            [34.5000, 105.5000],  // 陕西边界
            [35.0000, 106.0000],  // 陕西境内
            [35.5000, 106.5000],  // 接近吴起镇
            [36.0000, 107.0000],  // 继续向吴起镇
            [36.5000, 107.5000],  // 陕北境内
            [36.92785, 108.17611]  // 吴起镇（长征终点）
        ];
        
        // 绘制红军长征路线
        var longMarchPath = L.polyline(
            enhancedMarchCoordinates,
            {
                color: '#FFB6C1',  // 粉色
                weight: 4,
                opacity: 0.9,
                tooltip: '红军长征真实路线',
                popup: '红军长征（1934-1935）：从瑞金到吴起镇，翻雪山过草地的真实路径'
            }
        ).addTo(map);
        
        // 创建节点标记和信息
        var markers = [];
        var currentNodeIndex = -1;
        
        for (var i = 0; i < longMarchWaypoints.length; i++) {
            var waypoint = longMarchWaypoints[i];
            
            // 创建自定义HTML标记
            var markerHtml = `
            <div style="text-align: center;">
                <div style="
                    position: relative;
                    width: 40px;
                    height: 40px;
                    margin: 0 auto;
                ">
                    <!-- 自定义图标 -->
                    <div style="
                        background-color: #d32f2f;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        box-shadow: 0 0 10px rgba(211, 47, 47, 0.7);
                    ">🏮</div>
                    <!-- 右上角数字 -->
                    <div style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background-color: #ffd700;
                        color: #d32f2f;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
                    ">${i+1}</div>
                </div>
            </div>`;
            
            // 创建自定义图标
            var customIcon = L.divIcon({
                html: markerHtml,
                className: 'custom-div-icon',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            // 创建标记
            var marker = L.marker(waypoint.location, {
                icon: customIcon,
                title: `${i+1}. ${waypoint.name}`
            }).addTo(map);
            
            // 绑定弹出信息
            marker.bindPopup(`
                <div style="font-size: 14px;">
                    <strong>${waypoint.name}</strong><br>
                    ${waypoint.description}<br>
                    <button onclick="openDetailsForNode(${i})" 
                            style="margin-top: 10px; padding: 5px 10px; 
                                   background-color: #d32f2f; color: white; 
                                   border: none; border-radius: 4px; cursor: pointer;">
                        查看更多
                    </button>
                </div>
            `, {
                maxWidth: 300,
                minWidth: 200
            });
            
            markers.push(marker);
        }
        
        // 全局函数：打开节点详情
        window.openDetailsForNode = function(index) {
            var node = longMarchWaypoints[index];
            
            // 更新详情面板内容
            document.getElementById('detail-title').textContent = node.name;
            document.getElementById('detail-description').textContent = node.description;
            document.getElementById('detail-introduction').textContent = node.introduction;
            document.getElementById('detail-events').textContent = node.events;
            document.getElementById('detail-story').textContent = node.story;
            document.getElementById('detail-image').src = node.image;
            document.getElementById('detail-image').alt = node.name + '历史图片';
            
            // 显示详情面板
            var detailsPanel = document.getElementById('details-panel');
            detailsPanel.classList.add('show');
            
            // 更新当前节点索引
            currentNodeIndex = index;
            
            // 更新进度条
            updateProgress(index);
            
            // 移动地图到该节点
            map.setView(node.location, 10);
        };
        
        // 全局函数：关闭详情面板
        window.closeDetails = function() {
            var detailsPanel = document.getElementById('details-panel');
            detailsPanel.classList.remove('show');
        };
        
        // 全局函数：上一站
        window.prevNode = function() {
            if (currentNodeIndex > 0) {
                openDetailsForNode(currentNodeIndex - 1);
            } else if (currentNodeIndex === 0) {
                // 如果是第一个节点，则跳到最后一个节点
                openDetailsForNode(longMarchWaypoints.length - 1);
            } else {
                // 如果没有选中节点，则从第一个开始
                openDetailsForNode(0);
            }
        };
        
        // 全局函数：下一站
        window.nextNode = function() {
            if (currentNodeIndex < longMarchWaypoints.length - 1) {
                openDetailsForNode(currentNodeIndex + 1);
            } else if (currentNodeIndex === longMarchWaypoints.length - 1) {
                // 如果是最后一个节点，则跳到第一个节点
                openDetailsForNode(0);
            } else {
                // 如果没有选中节点，则从第一个开始
                openDetailsForNode(0);
            }
        };
        
        // 全局函数：重置地图
        window.resetMap = function() {
            map.setView([25.8856, 116.0270], 8);
            currentNodeIndex = -1;
            updateProgress(-1);
            closeDetails();
        };
        
        // 全局函数：切换背景音乐
        window.toggleAudio = function() {
            var audioBtn = document.getElementById('audio-btn');
            
            if (!window.audio) {
                // 创建音频元素
                window.audio = new Audio('https://assets.mixkit.co/music/preview/mixkit-revolutionary-music-box-649.mp3');
                window.audio.loop = true;
                
                // 尝试播放
                window.audio.play().then(function() {
                    audioBtn.textContent = '暂停背景音乐';
                }).catch(function(error) {
                    console.log('无法自动播放音频:', error);
                    alert('请手动点击播放音乐');
                });
            } else {
                if (window.audio.paused) {
                    window.audio.play();
                    audioBtn.textContent = '暂停背景音乐';
                } else {
                    window.audio.pause();
                    audioBtn.textContent = '播放背景音乐';
                }
            }
        };
        
        // 更新进度条
        function updateProgress(index) {
            var progressText = document.getElementById('progress-text');
            var progressFill = document.getElementById('progress-fill');
            
            if (index === -1) {
                progressText.textContent = '0%';
                progressFill.style.width = '0%';
            } else {
                var progress = Math.round(((index + 1) / longMarchWaypoints.length) * 100);
                progressText.textContent = progress + '%';
                progressFill.style.width = progress + '%';
            }
        }
        
        // 调整地图高度以适应移动设备
        function adjustMapHeight() {
            var headerHeight = document.getElementById('header-banner').offsetHeight;
            var mapContainer = document.querySelector('.map-container');
            
            mapContainer.style.height = 'calc(100vh - ' + headerHeight + 'px)';
        }
        
        // 初始化时调整地图高度
        adjustMapHeight();
        
        // 监听窗口大小变化，调整地图高度
        window.addEventListener('resize', adjustMapHeight);
        
        // 添加图层控制器
        L.control.layers({
            'OpenStreetMap': tileLayer,
            '卫星图': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            })
        }).addTo(map);
        
        // 添加比例尺
        L.control.scale().addTo(map);
        
        // 添加地图图例
        var legend = L.control({
            position: 'bottomright'
        });
        
        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>图例</h4>
                <i style="background: #FFB6C1; width: 20px; height: 3px;"></i> 红军长征路线<br>
                <i style="background: #d32f2f; border-radius: 50%; width: 20px; height: 20px;"></i> 长征节点<br>
            `;
            return div;
        };
        
        legend.addTo(map);
    // 添加行走动画样式
    addWalkingAnimation();
    
    // 为线段添加动画效果
    setTimeout(animatePaths, 2000);
    
    // 添加可拖拽的小士兵
    addSoldier();
    
    // 初始化进度
    updateProgress(0);
    
    // 为地图上的标记添加点击事件
    // 注意：这部分需要在地图完全加载后执行
    setTimeout(function() {
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            marker.addEventListener('click', function(e) {
                // 阻止事件冒泡，避免循环调用
                e.stopPropagation();
                updateProgress(index);
                // 调用openDetails函数打开详情页
                openDetails();
                // 确保浮窗能正确弹出
                if (marker._icon && marker._icon.parentNode && marker._icon.parentNode._popup) {
                    marker._icon.parentNode.openPopup();
                }
            });
        });
    }, 1000);
    
    // 添加CSS样式使详情面板可见
    setTimeout(function() {
        const style = document.createElement('style');
        style.textContent = `
            #details-panel.show {
                right: 0;
            }
            
            /* 红军小人样式 */
            #soldier {
                position: absolute;
                width: 40px;
                height: 60px;
                cursor: move;
                z-index: 999;
                transform-origin: center bottom;
                pointer-events: all;
            }
            
            #soldier.dragging {
                opacity: 0.8;
                transform: scale(1.1);
            }
            
            /* 红军小人行走动画 */
            @keyframes walk {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                25% {
                    transform: translateY(-5px) rotate(-3deg);
                }
                50% {
                    transform: translateY(0) rotate(3deg);
                }
                75% {
                    transform: translateY(-5px) rotate(-2deg);
                }
            }
            
            #soldier.walking {
                animation: walk 0.6s infinite ease-in-out;
            }
            
            /* 红军小人组件 */
            .soldier-body {
                position: relative;
                width: 40px;
                height: 60px;
            }
            
            .soldier-head {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 24px;
                height: 24px;
                background-color: #f5d0c5;
                border-radius: 50%;
                border: 2px solid #000;
            }
            
            .soldier-uniform {
                position: absolute;
                top: 24px;
                left: 50%;
                transform: translateX(-50%);
                width: 30px;
                height: 20px;
                background-color: #d32f2f;
                border: 2px solid #000;
            }
            
            .soldier-legs {
                position: absolute;
                top: 44px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 16px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-leg,
            .soldier-right-leg {
                width: 6px;
                height: 16px;
                background-color: #212121;
                border: 1px solid #000;
                position: relative;
            }
            
            .soldier-arms {
                position: absolute;
                top: 28px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 8px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-arm,
            .soldier-right-arm {
                width: 12px;
                height: 8px;
                background-color: #d32f2f;
                border: 1px solid #000;
            }
            
            /* 行走时的手脚动画 */
            #soldier.walking .soldier-left-leg {
                animation: leg-move 0.6s infinite ease-in-out;
            }
            
            #soldier.walking .soldier-right-leg {
                animation: leg-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-left-arm {
                animation: arm-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-right-arm {
                animation: arm-move 0.6s infinite ease-in-out;
            }
            
            @keyframes leg-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(-20deg);
                }
            }
            
            @keyframes arm-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(20deg);
                }
            }
        `;
        document.head.appendChild(style);
    }, 500);
    
    // 添加可拖拽的小人

    
    // 添加进度面板和顶部横幅
    function addProgressPanel() {
        // 创建顶部横幅
        const headerBanner = document.createElement('div');
        headerBanner.id = 'header-banner';
        headerBanner.innerHTML = '<h1>红军长征路线图</h1>';
        document.body.appendChild(headerBanner);
        
        // 创建进度面板
        const progressPanel = document.createElement('div');
        progressPanel.id = 'progress-panel';
        
        progressPanel.innerHTML = `
            <h3>长征进度</h3>
            <div id="progress-info">
                <div>已完成: <span id="progress-text">0%</span></div>
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <div id="current-location">当前位置: 起点</div>
            </div>
            <button id="prev-btn" class="control-btn">上一站</button>
            <button id="next-btn" class="control-btn">下一站</button>
        `;
        
        document.body.appendChild(progressPanel);
        
        // 添加事件监听器
        document.getElementById('prev-btn').addEventListener('click', function() {
            prevLocation();
        });
        
        document.getElementById('next-btn').addEventListener('click', function() {
            nextLocation();
        });
        
        // 创建详情面板
        const detailsPanel = document.createElement('div');
        detailsPanel.id = 'details-panel';
        
        document.body.appendChild(detailsPanel);
        
        // 创建关闭按钮
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener('click', function() {
            detailsPanel.classList.remove('show');
        });
        
        document.body.appendChild(closeBtn);
    }
    
    // 更新进度条
    let currentIndex = 0;
    function updateProgress(index) {
        currentIndex = index;
        const progressText = document.getElementById('progress-text');
        const progressFill = document.getElementById('progress-fill');
        const currentLocation = document.getElementById('current-location');
        
        if (index === 0) {
            progressText.textContent = '0%';
            progressFill.style.width = '0%';
            currentLocation.textContent = '当前位置: 起点';
        } else {
            const progress = Math.round((index / (longMarchWaypoints.length - 1)) * 100);
            progressText.textContent = progress + '%';
            progressFill.style.width = progress + '%';
            currentLocation.textContent = '当前位置: ' + longMarchWaypoints[index - 1].name;
        }
        
        // 平滑滚动到对应位置
        if (index > 0) {
            map.setView([longMarchWaypoints[index - 1].lat, longMarchWaypoints[index - 1].lng], 7);
        } else {
            map.setView([longMarchWaypoints[0].lat, longMarchWaypoints[0].lng], 4);
        }
    }
    
    // 上一站
    function prevLocation() {
        if (currentIndex > 0) {
            updateProgress(currentIndex - 1);
        }
    }
    
    // 下一站
    function nextLocation() {
        if (currentIndex < longMarchWaypoints.length) {
            updateProgress(currentIndex + 1);
        }
    }
    
    // 添加行走动画样式
    function addWalkingAnimation() {
        const style = document.createElement('style');
        style.textContent = `
            /* 路径动画样式 */
            .path-animation {
                stroke-dasharray: 10;
                animation: dash 30s linear infinite;
            }
            
            @keyframes dash {
                to {
                    stroke-dashoffset: -1000;
                }
            }
            
            /* 节点动画样式 */
            .node-pulse {
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.7;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // 为线段添加动画效果
    function animatePaths() {
        const paths = document.querySelectorAll('svg path.leaflet-interactive');
        paths.forEach((path, index) => {
            // 添加延迟以创建顺序动画效果
            setTimeout(() => {
                path.classList.add('path-animation');
            }, index * 500);
        });
        
        // 为标记添加脉冲动画
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            setTimeout(() => {
                const iconElement = marker.querySelector('div');
                if (iconElement) {
                    iconElement.classList.add('node-pulse');
                }
            }, (index + 1) * 800);
        });
    }
    
    // 打开详情页
    function openDetails() {
        const detailsPanel = document.getElementById('details-panel');
        detailsPanel.classList.add('show');
    }
    
    // 长征节点详情数据
    const longMarchDetails = [
        {
            name: "瑞金",
            date: "1934年10月",
            description: "红军从瑞金出发，开始了举世闻名的二万五千里长征。",
            significance: "长征的起点，标志着红军战略转移的开始。",
            history: "1934年10月10日，中共中央、中革军委率中央红军主力8.6万余人，从瑞金等地出发，开始长征。",
            image: "https://example.com/ruijin.jpg"
        },
        {
            name: "遵义会议会址",
            date: "1935年1月",
            description: "遵义会议确立了毛泽东在党中央和红军的领导地位。",
            significance: "中国共产党历史上一个生死攸关的转折点，挽救了党、挽救了红军、挽救了中国革命。",
            history: "1935年1月15日至17日，中共中央在遵义召开政治局扩大会议，确立了毛泽东在党中央和红军的领导地位。",
            image: "https://example.com/zunyi.jpg"
        },
        {
            name: "赤水河畔",
            date: "1935年1-3月",
            description: "四渡赤水战役是毛泽东军事指挥艺术的得意之作。",
            significance: "打乱了国民党军队的追缴计划，取得了战略转移中具有决定意义的胜利。",
            history: "1935年1月19日至3月22日，中央红军在毛泽东等指挥下，四渡赤水，巧妙穿插于国民党军重兵集团之间。",
            image: "https://example.com/chishui.jpg"
        },
        {
            name: "巧渡金沙江",
            date: "1935年5月",
            description: "红军不费一枪一弹，智取金沙江，摆脱了几十万国民党军的围追堵截。",
            significance: "实现了渡江北上的战略意图，取得了战略转移中具有决定意义的胜利。",
            history: "1935年5月3日至9日，红军主力在7条木船上，用7天7夜的时间，全部渡过金沙江。",
            image: "https://example.com/jinsha.jpg"
        },
        {
            name: "强渡大渡河",
            date: "1935年5月",
            description: "红军以无比的英勇精神强渡大渡河，飞夺泸定桥。",
            significance: "打破了蒋介石妄图把红军变成第二个石达开的迷梦。",
            history: "1935年5月25日，17名勇士强渡大渡河成功；5月29日，22名勇士飞夺泸定桥成功。",
            image: "https://example.com/daduhe.jpg"
        },
        {
            name: "翻雪山（夹金山）",
            date: "1935年6月",
            description: "红军克服了难以想象的困难，翻越了夹金山。",
            significance: "展示了红军不怕牺牲、百折不挠的革命英雄主义精神。",
            history: "1935年6月12日，红军先头部队翻越了长征途中的第一座大雪山——夹金山，海拔4000多米。",
            image: "https://example.com/jiajinshan.jpg"
        },
        {
            name: "过草地",
            date: "1935年8月",
            description: "红军过草地是长征中最艰苦的一段路程。",
            significance: "红军以惊人的毅力，战胜了饥饿、寒冷、疾病和死亡的威胁。",
            history: "1935年8月21日至26日，红军右路军经过5天的艰苦行军，走出了纵横数百里的水草地。",
            image: "https://example.com/caodi.jpg"
        },
        {
            name: "腊子口战役遗址",
            date: "1935年9月",
            description: "腊子口战役是红军长征中的一次重要战役。",
            significance: "打开了红军北上进入甘肃的通道。",
            history: "1935年9月16日，红军发起腊子口战役，经过激烈战斗，于17日晨攻克腊子口。",
            image: "https://example.com/lazikou.jpg"
        },
        {
            name: "哈达铺",
            date: "1935年9月",
            description: "哈达铺是红军长征中的'加油站'。",
            significance: "红军在这里得到了宝贵的休整和补充，并确定了继续北上的战略方针。",
            history: "1935年9月20日，红军到达哈达铺，在这里进行了休整，并通过报纸了解到陕北有红军根据地。",
            image: "https://example.com/hadapu.jpg"
        },
        {
            name: "榜罗镇会议会址",
            date: "1935年9月",
            description: "榜罗镇会议决定了红军长征的最终目的地。",
            significance: "确定了把中共中央和陕甘支队的落脚点放在陕北的战略决策。",
            history: "1935年9月27日，中共中央政治局在榜罗镇召开常委会议，决定把长征的落脚点放在陕北。",
            image: "https://example.com/bangluozhen.jpg"
        },
        {
            name: "吴起镇",
            date: "1935年10月",
            description: "中央红军到达吴起镇，标志着红一方面军长征的胜利结束。",
            significance: "红一方面军长征胜利结束，为中国革命打开了新局面。",
            history: "1935年10月19日，中共中央和红一方面军到达陕北吴起镇，与陕北红军会师。",
            image: "https://example.com/wuqizhen.jpg"
        }
    ];
    
    // 打开节点详情
    function openDetailsForNode(index) {
        const detailsPanel = document.getElementById('details-panel');
        const detail = longMarchDetails[index];
        
        detailsPanel.innerHTML = `
            <h2>${detail.name}</h2>
            <h3>${detail.date}</h3>
            
            <div class="detail-section">
                <h4>简介</h4>
                <p>${detail.description}</p>
            </div>
            
            <div class="detail-section">
                <h4>历史意义</h4>
                <p>${detail.significance}</p>
            </div>
            
            <div class="detail-section">
                <h4>历史背景</h4>
                <p>${detail.history}</p>
            </div>
            
            <div class="detail-section">
                <img src="${detail.image}" alt="${detail.name}" style="width: 100%; height: auto; border-radius: 4px;">
            </div>
        `;
        
        detailsPanel.classList.add('show');
    }
    
    // 添加图层控制器
    L.control.layers({
        'OpenStreetMap': tileLayer,
        '卫星图': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        })
    }).addTo(map);
    
    // 添加比例尺
    L.control.scale().addTo(map);
    
    // 添加地图图例
    var legend = L.control({
        position: 'bottomright'
    });
    
    legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <h4>图例</h4>
            <i style="background: #FFB6C1; width: 20px; height: 3px;"></i> 红军长征路线<br>
            <i style="background: #d32f2f; border-radius: 50%; width: 20px; height: 20px;"></i> 长征节点<br>      
        `;
        return div;
    };
    
    legend.addTo(map);
    
    // 添加行走动画样式
    addWalkingAnimation();
    
    // 为线段添加动画效果
    setTimeout(animatePaths, 2000);
    
    // 添加可拖拽的小士兵
    addSoldier();
    
    // 初始化进度
    updateProgress(0);
    
    // 为地图上的标记添加点击事件
    // 注意：这部分需要在地图完全加载后执行
    setTimeout(function() {
        const markers = document.querySelectorAll('.leaflet-marker-icon');
        markers.forEach((marker, index) => {
            marker.addEventListener('click', function(e) {
                // 阻止事件冒泡，避免循环调用
                e.stopPropagation();
                updateProgress(index);
                // 调用openDetails函数打开详情页
                openDetails();
                // 确保浮窗能正确弹出
                if (marker._icon && marker._icon.parentNode && marker._icon.parentNode._popup) {
                    marker._icon.parentNode.openPopup();
                }
            });
        });
    }, 1000);
    
    // 添加CSS样式使详情面板可见
    setTimeout(function() {
        const style = document.createElement('style');
        style.textContent = `
            #details-panel.show {
                right: 0;
            }
            
            /* 红军小人样式 */
            #soldier {
                position: absolute;
                width: 40px;
                height: 60px;
                cursor: move;
                z-index: 999;
                transform-origin: center bottom;
                pointer-events: all;
            }
            
            #soldier.dragging {
                opacity: 0.8;
                transform: scale(1.1);
            }
            
            /* 红军小人行走动画 */
            @keyframes walk {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                25% {
                    transform: translateY(-5px) rotate(-3deg);
                }
                50% {
                    transform: translateY(0) rotate(3deg);
                }
                75% {
                    transform: translateY(-5px) rotate(-2deg);
                }
            }
            
            #soldier.walking {
                animation: walk 0.6s infinite ease-in-out;
            }
            
            /* 红军小人组件 */
            .soldier-body {
                position: relative;
                width: 40px;
                height: 60px;
            }
            
            .soldier-head {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 24px;
                height: 24px;
                background-color: #f5d0c5;
                border-radius: 50%;
                border: 2px solid #000;
            }
            
            .soldier-uniform {
                position: absolute;
                top: 24px;
                left: 50%;
                transform: translateX(-50%);
                width: 30px;
                height: 20px;
                background-color: #d32f2f;
                border: 2px solid #000;
            }
            
            .soldier-legs {
                position: absolute;
                top: 44px;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 16px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-leg,
            .soldier-right-leg {
                width: 6px;
                height: 16px;
                background-color: #212121;
                border: 1px solid #000;
                position: relative;
            }
            
            .soldier-arms {
                position: absolute;
                top: 28px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 8px;
                display: flex;
                justify-content: space-between;
            }
            
            .soldier-left-arm,
            .soldier-right-arm {
                width: 12px;
                height: 8px;
                background-color: #d32f2f;
                border: 1px solid #000;
            }
            
            /* 行走时的手脚动画 */
            #soldier.walking .soldier-left-leg {
                animation: leg-move 0.6s infinite ease-in-out;
            }
            
            #soldier.walking .soldier-right-leg {
                animation: leg-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-left-arm {
                animation: arm-move 0.6s infinite ease-in-out 0.3s;
            }
            
            #soldier.walking .soldier-right-arm {
                animation: arm-move 0.6s infinite ease-in-out;
            }
            
            @keyframes leg-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(-20deg);
                }
            }
            
            @keyframes arm-move {
                0%, 100% {
                    transform: rotate(0deg);
                }
                50% {
                    transform: rotate(20deg);
                }
            }
        `;
        document.head.appendChild(style);
    }, 500);
    
    // 添加可拖拽的小人
    function addSoldier() {
        const soldier = document.createElement('div');
        soldier.id = 'soldier';
        
        // 创建带有手和脚的小人HTML结构
        soldier.innerHTML = `
            <div class="soldier-body">
                <div class="soldier-head"></div>
                <div class="soldier-uniform"></div>
                <div class="soldier-arms">
                    <div class="soldier-left-arm"></div>
                    <div class="soldier-right-arm"></div>
                </div>
                <div class="soldier-legs">
                    <div class="soldier-left-leg"></div>
                    <div class="soldier-right-leg"></div>
                </div>
            </div>
        `;
        
        // 设置初始位置
        soldier.style.left = '60px';
        soldier.style.bottom = '60px';
        
        document.body.appendChild(soldier);
        
        let isDragging = false;
        let currentX, currentY, initialX, initialY;
        let pathIndex = -1;
        let isWalking = false;
        let startTime = null;
        let currentProgress = 0;
        let duration = 20000;
        
        // 获取所有路线元素
        function getPathElements() {
            return document.querySelectorAll('svg path.leaflet-interactive');
        }
        
        // 检查点是否在路径上
        function isPointOnPath(x, y, pathElement) {
            // 获取SVG元素
            const svgElement = pathElement.closest('svg');
            if (!svgElement) return false;
            
            const svgRect = svgElement.getBoundingClientRect();
            
            // 检查点击位置是否在SVG矩形内
            if (x < svgRect.left - 10 || x > svgRect.right + 10 || y < svgRect.top - 10 || y > svgRect.bottom + 10) {
                return false;
            }
            
            try {
                // 获取SVG的CTM(Current Transformation Matrix)以将屏幕坐标转换为SVG坐标
                const point = svgElement.createSVGPoint();
                point.x = x;
                point.y = y;
                
                // 获取SVG元素的坐标系中的点
                const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                
                // 使用isPointInStroke和isPointInFill来检测点是否在线上
                const isInStroke = pathElement.isPointInStroke(transformedPoint);
                const isInFill = pathElement.isPointInFill(transformedPoint);
                
                // 使用getPointAtLength进行更精确的检测
                const pathLength = pathElement.getTotalLength();
                
                // 增加采样密度以提高检测精度
                for (let i = 0; i <= pathLength; i += 1) {
                    const pathPoint = pathElement.getPointAtLength(i);
                    const distance = Math.sqrt(
                        Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                        Math.pow(transformedPoint.y - pathPoint.y, 2)
                    );
                    
                    // 扩大检测范围到20像素以提高成功率
                    if (distance < 20) {
                        return true;
                    }
                }
                
                return isInStroke || isInFill;
            } catch (error) {
                console.error('检测路径点出错:', error);
                return false;
            }
        }
        
        // 找到小士兵所在的路径索引
        function findPathIndex(x, y) {
            const paths = getPathElements();
            for (let i = 0; i < paths.length; i++) {
                // 直接传递绝对坐标给isPointOnPath
                if (isPointOnPath(x, y, paths[i])) {
                    console.log('找到路径索引:', i);
                    return i;
                }
            }
            console.log('未找到路径');
            return -1;
        }
        
        // 找到点在路径上的最近位置，并返回进度值(0-1)
        function findClosestPointOnPath(x, y, pathElement) {
            const svgElement = pathElement.closest('svg');
            if (!svgElement) return -1;
            
            try {
                const point = svgElement.createSVGPoint();
                point.x = x;
                point.y = y;
                
                const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                const pathLength = pathElement.getTotalLength();
                
                let minDistance = Infinity;
                let closestPointIndex = 0;
                
                // 在路径上采样更多点以找到最近点
                for (let i = 0; i <= pathLength; i += 5) {
                    const pathPoint = pathElement.getPointAtLength(i);
                    const distance = Math.sqrt(
                        Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                        Math.pow(transformedPoint.y - pathPoint.y, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPointIndex = i;
                    }
                }
                
                // 只有当最近点足够近时才返回进度值
                if (minDistance < 30) {
                    return closestPointIndex / pathLength;
                }
                
                return -1;
            } catch (error) {
                console.error('计算路径最近点出错:', error);
                return -1;
            }
        }
        
        // 沿路径移动小人
        function moveAlongPath(pathIndex, duration = 20000, startPosition = null) { // 减慢速度为20秒
            const paths = getPathElements();
            if (pathIndex < 0 || pathIndex >= paths.length) return;
            
            // 开始行走动画
            isWalking = true;
            soldier.classList.add('walking');
            
            const path = paths[pathIndex];
            const pathLength = path.getTotalLength();
            let startTime = null;
            let currentProgress = 0; // 保存当前行走进度
            
            // 如果提供了起始位置（拖拽释放的位置），计算在路径上的进度
            if (startPosition) {
                const progress = findClosestPointOnPath(startPosition.x, startPosition.y, path);
                if (progress >= 0) {
                    currentProgress = progress;
                    console.log('从拖拽位置开始移动，进度:', currentProgress);
                }
            }
            
            function move(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = currentProgress + (timestamp - startTime) / duration;
                
                if (progress < 1 && isWalking) {
                    const point = path.getPointAtLength(progress * pathLength);
                    
                    // 获取地图容器位置
                    const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
                    if (!mapContainer) {
                        console.error('地图容器未找到');
                        return;
                    }
                    
                    const mapRect = mapContainer.getBoundingClientRect();
                    const svgElement = path.closest('svg');
                    
                    if (svgElement) {
                        const svgRect = svgElement.getBoundingClientRect();
                        
                        // 修复计算逻辑，确保小人准确沿着路线行走
                        const mapX = point.x + svgRect.left - mapRect.left - 20; // 减去小人宽度的一半使其居中
                        const mapY = point.y + svgRect.top - mapRect.top - 28; // 调整垂直位置，确保脚踩在线上
                        
                        // 确保位置在合理范围内，防止小人消失
                        const containerWidth = mapContainer.offsetWidth;
                        const containerHeight = mapContainer.offsetHeight;
                        const soldierWidth = 40;
                        const soldierHeight = 60;
                        
                        // 限制小人在地图容器内
                        const safeX = Math.max(0, Math.min(mapX, containerWidth - soldierWidth));
                        const safeY = Math.max(0, Math.min(mapY, containerHeight - soldierHeight));
                        
                        // 设置小人位置（相对于地图容器）
                        soldier.style.position = 'absolute';
                        soldier.style.left = safeX + 'px';
                        soldier.style.top = safeY + 'px';
                        soldier.style.bottom = 'auto';
                        
                        // 确保小人始终显示在地图上方
                        soldier.style.zIndex = '999';
                        
                        // 确保小人元素是可见的
                        soldier.style.display = 'block';
                    }
                    
                    // 确保动画持续进行
                    if (typeof window.requestAnimationFrame === 'function') {
                        requestAnimationFrame(move);
                    } else {
                        // 降级方案 - 使用setTimeout作为后备
                        setTimeout(() => move(Date.now()), 16); // 约60fps
                    }
                } else {
                    // 移动结束
                    isWalking = false;
                    soldier.classList.remove('walking');
                    
                    // 移动到下一站
                    currentNodeIndex = Math.min(currentNodeIndex + 1, totalNodes - 1);
                    updateProgress(currentNodeIndex);
                    
                    // 检查是否到达终点
                    if (currentNodeIndex >= totalNodes - 1) {
                        // 延迟3秒后返回界面左下方
                        setTimeout(() => {
                            // 重置位置到界面左下方
                            resetSoldierPosition();
                        }, 3000);
                    }
                }
            }
            
            // 确保动画开始，并重置startTime确保从路径起点开始
            startTime = null;
            if (typeof window.requestAnimationFrame === 'function') {
                requestAnimationFrame(move);
            } else {
                // 降级方案
                move(Date.now());
            }
            console.log('开始沿路径移动小人，路径索引:', pathIndex);
        }
        
        // 重置小人到界面左下方
        function resetSoldierPosition() {
            // 确保地图容器存在
            const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
            if (!mapContainer) {
                console.error('地图容器未找到');
                return;
            }
            
            // 停止任何行走动画
            isWalking = false;
            soldier.classList.remove('walking');
            
            // 重置到界面左下方，使用相对定位以避免受到地图缩放影响
            soldier.style.position = 'absolute';
            soldier.style.left = '60px';
            soldier.style.bottom = '60px';
            soldier.style.top = 'auto';
            
            // 确保小人可见
            soldier.style.zIndex = '999';
            soldier.style.display = 'block';
            
            // 重置路径索引
            pathIndex = -1;
            
            console.log('小人已重置到界面左下方');
        }
            
        // 鼠标按下事件
        soldier.addEventListener('mousedown', function(e) {
            // 停止行走动画
            if (isWalking) {
                isWalking = false;
                soldier.classList.remove('walking');
            }
            
            initialX = e.clientX;
            initialY = e.clientY;
            isDragging = true;
            soldier.classList.add('dragging');
            
            // 改变为固定定位以便拖拽
            soldier.style.position = 'fixed';
        });
            
        // 鼠标移动事件
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                initialX = e.clientX;
                initialY = e.clientY;
                
                const newLeft = parseInt(soldier.style.left || '60px') + currentX;
                const newBottom = parseInt(soldier.style.bottom || '60px') - currentY;
                
                // 限制在视口内
                if (newLeft > 0 && newLeft < window.innerWidth - 40) {
                    soldier.style.left = newLeft + 'px';
                }
                if (newBottom > 0 && newBottom < window.innerHeight - 40) {
                    soldier.style.bottom = newBottom + 'px';
                }
            }
        });
            
        // 鼠标释放事件
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                soldier.classList.remove('dragging');
                
                // 获取小人中心点坐标
                const rect = soldier.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                // 寻找所有路径中最近的点，无论是否在路径上
                let closestPathIndex = -1;
                let closestProgress = -1;
                let minDistance = Infinity;
                const paths = getPathElements();
                
                // 遍历所有路径找到最近的点
                for (let i = 0; i < paths.length; i++) {
                    const path = paths[i];
                    const svgElement = path.closest('svg');
                    if (!svgElement) continue;
                    
                    try {
                        const point = svgElement.createSVGPoint();
                        point.x = x;
                        point.y = y;
                        
                        const transformedPoint = point.matrixTransform(svgElement.getScreenCTM().inverse());
                        const pathLength = path.getTotalLength();
                        let pathMinDistance = Infinity;
                        let closestPointIndex = 0;
                        
                        // 在路径上采样更多点以找到最近点
                        for (let j = 0; j <= pathLength; j += 2) { // 增加采样密度
                            const pathPoint = path.getPointAtLength(j);
                            const distance = Math.sqrt(
                                Math.pow(transformedPoint.x - pathPoint.x, 2) + 
                                Math.pow(transformedPoint.y - pathPoint.y, 2)
                            );
                            
                            if (distance < pathMinDistance) {
                                pathMinDistance = distance;
                                closestPointIndex = j;
                            }
                        }
                        
                        // 找到此路径上的最近点
                        if (pathMinDistance < minDistance) {
                            minDistance = pathMinDistance;
                            closestPathIndex = i;
                            closestProgress = closestPointIndex / pathLength;
                        }
                    } catch (error) {
                        console.error('计算路径最近点出错:', error);
                    }
                }
                
                // 如果找到足够近的路径（距离阈值设为60像素）
                if (closestPathIndex !== -1 && minDistance < 60) {
                    pathIndex = closestPathIndex;
                    
                    // 获取对应的路径元素
                    const path = paths[pathIndex];
                    
                    // 将小人位置转换为相对于地图容器的坐标
                    const mapContainer = document.querySelector('.map-container, .folium-map') || document.querySelector('.folium-map');
                    if (mapContainer) {
                        const mapRect = mapContainer.getBoundingClientRect();
                        const svgElement = path.closest('svg');
                        
                        if (svgElement) {
                            const svgRect = svgElement.getBoundingClientRect();
                            
                            // 立即将小人定位到路径上的精确位置
                            const point = path.getPointAtLength(closestProgress * path.getTotalLength());
                            const mapX = point.x + svgRect.left - mapRect.left - 20;
                            const mapY = point.y + svgRect.top - mapRect.top - 28;
                            
                            // 设置位置
                            soldier.style.position = 'absolute';
                            soldier.style.left = mapX + 'px';
                            soldier.style.top = mapY + 'px';
                            soldier.style.bottom = 'auto';
                            soldier.style.zIndex = '999';
                            soldier.style.display = 'block';
                            
                            // 从该位置开始沿路径移动
                            moveAlongPath(pathIndex, 20000, {x: mapX + 20, y: mapY + 28});
                        }
                    }
                } else {
                    // 如果不在任何路线附近，确保小人不会消失
                    soldier.style.display = 'block';
                    soldier.style.zIndex = '999';
                }
            }
        });
            
        // 监听地图拖动事件，确保小人在行走时不受影响
        const map = getMap();
        if (map) {
            map.on('dragstart', function() {
                if (isWalking) {
                    // 保存当前位置
                    const rect = soldier.getBoundingClientRect();
                    const mapContainer = document.querySelector('.map-container, .folium-map');
                    const mapRect = mapContainer.getBoundingClientRect();
                    
                    // 保存当前进度
                    if (startTime) {
                        const elapsedTime = Date.now() - startTime;
                        currentProgress = Math.min(elapsedTime / duration, 1);
                    }
                    
                    // 转换为相对于地图的位置
                    soldier.style.position = 'absolute';
                    soldier.style.left = (rect.left - mapRect.left) + 'px';
                    soldier.style.top = (rect.top - mapRect.top) + 'px';
                    soldier.style.bottom = 'auto';
                }
            });
            
            map.on('dragend', function() {
                if (isWalking) {
                    // 继续行走动画，从保存的进度继续
                    if (pathIndex !== -1) {
                        // 重置startTime但保留进度
                        startTime = null;
                        if (typeof window.requestAnimationFrame === 'function') {
                            requestAnimationFrame(move);
                        } else {
                            move(Date.now());
                        }
                    }
                }
            });
        }
    }
    
    // 初始化添加进度面板
    addProgressPanel();
</script>
</body>
</html>